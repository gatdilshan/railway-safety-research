<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Railway Safety System</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 10px;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 20px;
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        padding: 10px;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: clamp(1.1rem, 3vw, 1.5rem);
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        word-wrap: break-word;
      }

      #map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-top: 15px;
        min-height: 300px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      @media (max-width: 1024px) {
        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 10px;
        border-radius: 8px;
        text-align: center;
        min-width: 0;
      }

      .stat-box .label {
        font-size: clamp(0.75rem, 2vw, 0.9rem);
        opacity: 0.9;
        margin-bottom: 5px;
        word-wrap: break-word;
      }

      .stat-box .value {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        font-weight: bold;
        word-break: break-all;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 15px;
      }

      #dataTable {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      #dataTable th,
      #dataTable td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        font-size: clamp(0.75rem, 2vw, 0.95rem);
      }

      #dataTable th {
        background: #667eea;
        color: white;
        font-weight: 600;
        white-space: nowrap;
      }

      #dataTable td {
        white-space: nowrap;
      }

      #dataTable tr:hover {
        background: #f5f5f5;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: clamp(0.9rem, 2vw, 1rem);
        margin-top: 15px;
        transition: transform 0.2s;
        width: 100%;
        max-width: 300px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: 600;
      }

      .status.online {
        background: #4caf50;
        color: white;
      }

      .status.offline {
        background: #f44336;
        color: white;
      }

      .train-control {
        margin-top: 20px;
        text-align: center;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 40px;
        margin: 20px auto;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 40px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 32px;
        width: 32px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #4caf50;
      }

      input:checked + .slider:before {
        transform: translateX(40px);
      }

      .train-status-text {
        font-size: 1.2em;
        font-weight: bold;
        margin-top: 10px;
      }

      .train-status-text.active {
        color: #4caf50;
      }

      .train-status-text.inactive {
        color: #f44336;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 1.5rem;
        color: #667eea;
        margin-bottom: 20px;
        font-weight: bold;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: #000;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        width: 100%;
        transition: transform 0.2s;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* Session Item Styles */
      .session-item {
        background: #f9f9f9;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        transition: transform 0.2s;
      }

      .session-item:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .session-title {
        font-weight: bold;
        color: #333;
        font-size: 1.1rem;
      }

      .session-status {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .session-status.created {
        background: #ffc107;
        color: #000;
      }

      .session-status.active {
        background: #4caf50;
        color: white;
      }

      .session-status.completed {
        background: #9e9e9e;
        color: white;
      }

      .session-info {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      .session-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .btn-small {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: transform 0.2s;
      }

      .btn-small:hover {
        transform: translateY(-2px);
      }

      .btn-start {
        background: #4caf50;
        color: white;
      }

      .btn-stop {
        background: #f44336;
        color: white;
      }

      .btn-delete {
        background: #ff9800;
        color: white;
      }

      .btn-view {
        background: #2196f3;
        color: white;
      }

      /* Session View Modal */
      .session-view-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        overflow-y: auto;
      }

      .session-view-content {
        background-color: white;
        margin: 20px auto;
        padding: 30px;
        border-radius: 12px;
        width: 95%;
        max-width: 1200px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .session-map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin: 20px 0;
        border: 2px solid #667eea;
      }

      .session-data-table {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .route-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .route-info-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .route-info-box .label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .route-info-box .value {
        font-size: 1.3rem;
        font-weight: bold;
      }

      /* Success Confirmation Modal */
      .success-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .success-modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.4s ease-out;
        overflow: hidden;
      }

      .success-modal-header {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        padding: 30px 20px;
        text-align: center;
        color: white;
      }

      .success-icon {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        animation: scaleIn 0.5s ease-out 0.2s both;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0);
        }
        to {
          transform: scale(1);
        }
      }

      .success-modal-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
      }

      .success-modal-body {
        padding: 30px;
        text-align: center;
      }

      .success-modal-body p {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 25px;
        line-height: 1.6;
      }

      .success-modal-footer {
        padding: 0 30px 30px;
        text-align: center;
      }

      .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .btn-success:active {
        transform: translateY(0);
      }

      /* Tabs Styles */
      .tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        margin-bottom: 20px;
      }

      .tabs-header {
        display: flex;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 0;
      }

      .tab-button {
        flex: 1;
        padding: 18px 20px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        border-bottom: 3px solid transparent;
      }

      .tab-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .tab-button.active {
        color: white;
        background: rgba(255, 255, 255, 0.15);
        border-bottom: 3px solid white;
      }

      .tab-content {
        display: none;
        padding: 20px;
        animation: fadeInTab 0.3s ease-in;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeInTab {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .tab-icon {
        margin-right: 8px;
      }

      /* Tablet breakpoint */
      @media (max-width: 1024px) {
        body {
          padding: 15px;
        }

        .dashboard {
          gap: 15px;
        }

        .card {
          padding: 18px;
        }

        #map {
          height: 350px;
        }

        .tab-button {
          padding: 15px 15px;
          font-size: 1rem;
        }

        .tab-icon {
          display: inline;
        }
      }

      /* Mobile breakpoint */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        h1 {
          margin-bottom: 15px;
        }

        .dashboard {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .card {
          padding: 15px;
        }

        .stats {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        #map {
          height: 300px;
        }

        .refresh-btn {
          max-width: 100%;
          padding: 14px 20px;
        }

        .train-control p {
          font-size: 1rem;
        }

        .train-status-text {
          font-size: 1rem;
        }
      }

      /* Small mobile breakpoint */
      @media (max-width: 480px) {
        body {
          padding: 8px;
        }

        h1 {
          margin-bottom: 12px;
        }

        .dashboard {
          gap: 12px;
        }

        .card {
          padding: 12px;
          border-radius: 10px;
        }

        .card h2 {
          font-size: 1.1rem;
          margin-bottom: 12px;
        }

        .stat-box {
          padding: 12px 8px;
        }

        #map {
          height: 250px;
          min-height: 250px;
        }

        #dataTable th,
        #dataTable td {
          padding: 8px 6px;
          font-size: 0.8rem;
        }

        .toggle-switch {
          width: 70px;
          height: 35px;
        }

        .slider:before {
          height: 28px;
          width: 28px;
        }

        input:checked + .slider:before {
          transform: translateX(35px);
        }

        .success-modal-content {
          margin: 30% auto;
          width: 95%;
          max-width: 350px;
        }

        .success-icon {
          width: 60px;
          height: 60px;
          font-size: 2.5rem;
        }

        .success-modal-header h2 {
          font-size: 1.4rem;
        }

        .success-modal-body p {
          font-size: 1rem;
        }

        .btn-success {
          padding: 12px 30px;
          font-size: 1rem;
        }

        .tab-button {
          padding: 12px 10px;
          font-size: 0.9rem;
        }

        .tab-icon {
          font-size: 1rem;
          margin-right: 5px;
        }

        .tab-content {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>📡 Railway Safety System</h1>

      <!-- Tabs Container -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchTab('dashboard')">
            <span class="tab-icon">📊</span> Dashboard
          </button>
          <button class="tab-button" onclick="switchTab('sessions')">
            <span class="tab-icon">🗂️</span> Coordinate Sessions
          </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
          <div class="dashboard">
            <div class="card">
              <h2>📍 Live Location</h2>
              <div id="map"></div>
            </div>

            <div class="card">
              <h2>📊 Statistics</h2>

              <!-- Device Filter -->
              <div
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: #f5f5f5;
                  border-radius: 8px;
                "
              >
                <label
                  for="deviceFilter"
                  style="
                    font-weight: 600;
                    color: #667eea;
                    margin-bottom: 8px;
                    display: block;
                  "
                >
                  🆔 Select Device:
                </label>
                <select
                  id="deviceFilter"
                  onchange="filterByDevice()"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #667eea;
                    border-radius: 6px;
                    font-size: 1rem;
                    cursor: pointer;
                    background: white;
                  "
                >
                  <option value="all">📡 All Devices</option>
                </select>
                <div
                  id="deviceStatus"
                  style="margin-top: 10px; font-size: 0.9rem; color: #666"
                >
                  Loading devices...
                </div>
              </div>

              <div class="stats">
                <div class="stat-box">
                  <div class="label">Latitude</div>
                  <div class="value" id="latValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Longitude</div>
                  <div class="value" id="lonValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Satellites</div>
                  <div class="value" id="satValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">HDOP</div>
                  <div class="value" id="hdopValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Accuracy</div>
                  <div class="value" id="accuracyValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Device ID</div>
                  <div
                    class="value"
                    id="deviceIdValue"
                    style="font-size: clamp(0.8rem, 2.5vw, 1.2rem)"
                  >
                    --
                  </div>
                </div>
              </div>
              <p
                style="
                  margin-top: 20px;
                  text-align: center;
                  font-size: clamp(0.9rem, 2vw, 1rem);
                "
              >
                <!-- <strong>Status:</strong>
            <span id="deviceStatus" class="status offline">Offline</span> -->
              </p>
              <p
                style="
                  text-align: center;
                  margin-top: 10px;
                  color: #666;
                  font-size: clamp(0.85rem, 2vw, 0.95rem);
                "
              >
                Last Update: <span id="lastUpdate">Never</span>
              </p>
              <div style="display: flex; justify-content: center">
                <button class="refresh-btn" onclick="fetchGPSData()">
                  🔄 Refresh Data
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>🚂 Train Control</h2>
            <div class="train-control">
              <p
                style="
                  font-size: clamp(0.95rem, 2.5vw, 1.1rem);
                  margin-bottom: 10px;
                  color: #666;
                  padding: 0 10px;
                "
              >
                Control train alert system (buzzer/lights)
              </p>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="trainActiveToggle"
                  onchange="toggleTrainStatus()"
                />
                <span class="slider"></span>
              </label>
              <div class="train-status-text inactive" id="trainStatusText">
                🔴 Alert System: INACTIVE
              </div>
              <p
                style="
                  margin-top: 15px;
                  color: #666;
                  font-size: clamp(0.8rem, 2vw, 0.9rem);
                "
              >
                Last Updated: <span id="trainLastUpdate">Never</span>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>📋 Recent GPS Data</h2>
            <div class="table-container">
              <table id="dataTable">
                <thead>
                  <tr>
                    <th>Device ID</th>
                    <th>Timestamp</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Satellites</th>
                    <th>HDOP</th>
                    <th>Accuracy (m)</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="7" style="text-align: center; color: #999">
                      Loading data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- End Dashboard Tab -->

        <!-- Coordinate Sessions Tab -->
        <div id="sessionsTab" class="tab-content">
          <div class="card" style="margin-bottom: 0">
            <h2>🗂️ Coordinate Sessions</h2>
            <p style="color: #666; margin-bottom: 20px">
              Create and manage GPS recording sessions. Track your route from
              start to finish and view the complete journey on a map.
            </p>
            <div style="margin-top: 15px">
              <button
                class="refresh-btn"
                onclick="openNewSessionModal()"
                style="margin-bottom: 20px"
              >
                ➕ Start New Session
              </button>
              <div id="sessionsList" style="margin-top: 15px">
                <p style="text-align: center; color: #999">
                  Loading sessions...
                </p>
              </div>
            </div>
          </div>
        </div>
        <!-- End Coordinate Sessions Tab -->
      </div>
      <!-- End Tabs Container -->
    </div>

    <!-- New Session Modal -->
    <div id="newSessionModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeNewSessionModal()">&times;</span>
        <div class="modal-header">🆕 Create New Session</div>
        <form onsubmit="createNewSession(event)">
          <div class="form-group">
            <label for="startPoint">Start Point Name:</label>
            <input
              type="text"
              id="startPoint"
              placeholder="e.g., Colombo Fort"
              required
            />
          </div>
          <div class="form-group">
            <label for="endPoint">End Point Name:</label>
            <input
              type="text"
              id="endPoint"
              placeholder="e.g., Galle"
              required
            />
          </div>
          <button type="submit" class="btn-primary">Create Session</button>
        </form>
      </div>
    </div>

    <!-- Success Confirmation Modal -->
    <div id="successModal" class="success-modal">
      <div class="success-modal-content">
        <div class="success-modal-header">
          <div class="success-icon">✓</div>
          <h2 id="successTitle">Success!</h2>
        </div>
        <div class="success-modal-body">
          <p id="successMessage">
            Session created successfully! You can now start it.
          </p>
        </div>
        <div class="success-modal-footer">
          <button class="btn-success" onclick="closeSuccessModal()">OK</button>
        </div>
      </div>
    </div>

    <!-- Session View Modal -->
    <div id="sessionViewModal" class="session-view-modal">
      <div class="session-view-content">
        <span class="close" onclick="closeSessionViewModal()">&times;</span>
        <div class="modal-header" id="sessionViewTitle">📍 Session Details</div>

        <div class="route-info" id="routeInfo">
          <div class="route-info-box">
            <div class="label">Start Point</div>
            <div class="value" id="viewStartPoint">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">End Point</div>
            <div class="value" id="viewEndPoint">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">GPS Points</div>
            <div class="value" id="viewGpsCount">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Distance</div>
            <div class="value" id="viewDistance">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Started</div>
            <div class="value" id="viewStartTime">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Ended</div>
            <div class="value" id="viewEndTime">--</div>
          </div>
        </div>

        <h3 style="color: #667eea; margin-top: 20px">🗺️ Route Map</h3>
        <div id="sessionMap" class="session-map"></div>

        <h3 style="color: #667eea; margin-top: 30px">📋 GPS Data</h3>
        <div class="session-data-table">
          <table
            id="sessionDataTable"
            style="width: 100%; border-collapse: collapse"
          >
            <thead>
              <tr style="background: #667eea; color: white">
                <th style="padding: 12px; text-align: left">#</th>
                <th style="padding: 12px; text-align: left">Device ID</th>
                <th style="padding: 12px; text-align: left">Timestamp</th>
                <th style="padding: 12px; text-align: left">Latitude</th>
                <th style="padding: 12px; text-align: left">Longitude</th>
                <th style="padding: 12px; text-align: left">Satellites</th>
                <th style="padding: 12px; text-align: left">HDOP</th>
                <th style="padding: 12px; text-align: left">Accuracy (m)</th>
              </tr>
            </thead>
            <tbody id="sessionDataTableBody">
              <tr>
                <td
                  colspan="8"
                  style="text-align: center; padding: 20px; color: #999"
                >
                  Loading GPS data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button class="btn-primary" onclick="closeSessionViewModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Use relative URL so it works both locally and on Render
      const API_URL = window.location.origin + "/api/gps";
      const TRAIN_API_URL = window.location.origin + "/api/train/status";
      const SESSIONS_API_URL = window.location.origin + "/api/sessions";
      const DEVICES_API_URL = window.location.origin + "/api/devices";
      let map;
      let sessionMap = null;
      let sessionPolyline = null;
      let sessionMarkers = [];
      let deviceMarkers = {}; // Store markers for each device
      let currentDeviceFilter = "all"; // Current selected device filter
      let allDevices = []; // Store all devices

      // Initialize map
      function initMap() {
        map = L.map("map").setView([6.9271, 79.8612], 13); // Default: Colombo, Sri Lanka

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
          maxZoom: 19,
        }).addTo(map);
      }

      // Fetch GPS data from backend
      async function fetchGPSData() {
        try {
          let url = API_URL + "?limit=100";

          // If a specific device is selected, fetch only that device's data
          if (currentDeviceFilter !== "all") {
            url = API_URL + "/" + currentDeviceFilter + "?limit=100";
          }

          const response = await fetch(url);
          const result = await response.json();

          if (result.success && result.data.length > 0) {
            // If filtering by device, show latest from that device
            // If showing all, show latest overall
            const latestData = result.data[0];
            updateDashboard(latestData);
            updateTable(result.data);

            // Update all device markers on map
            updateDeviceMarkers(result.data);
          } else {
            console.log("No GPS data available yet");
          }
        } catch (error) {
          console.error("Error fetching GPS data:", error);
        }
      }

      // Fetch and update device list
      async function fetchDevices() {
        try {
          const response = await fetch(DEVICES_API_URL);
          const result = await response.json();

          if (result.success) {
            allDevices = result.devices;
            updateDeviceSelector(result.devices);
            updateDeviceStatusDisplay(result.devices);
          }
        } catch (error) {
          console.error("Error fetching devices:", error);
        }
      }

      // Update device selector dropdown
      function updateDeviceSelector(devices) {
        const selector = document.getElementById("deviceFilter");
        const currentValue = selector.value;

        // Clear existing options except "All Devices"
        selector.innerHTML = '<option value="all">📡 All Devices</option>';

        // Add option for each device
        devices.forEach((device) => {
          const option = document.createElement("option");
          option.value = device.device_id;
          option.textContent = `🆔 ${device.device_id}`;
          selector.appendChild(option);
        });

        // Restore previous selection if it still exists
        if (
          currentValue !== "all" &&
          devices.find((d) => d.device_id === currentValue)
        ) {
          selector.value = currentValue;
        }
      }

      // Update device status display
      function updateDeviceStatusDisplay(devices) {
        const statusDiv = document.getElementById("deviceStatus");
        const now = Date.now();

        if (devices.length === 0) {
          statusDiv.innerHTML = "⚠️ No devices found";
          return;
        }

        let onlineCount = 0;
        let offlineCount = 0;

        devices.forEach((device) => {
          const timeDiff = now - new Date(device.last_seen).getTime();
          if (timeDiff < 60000) {
            // Less than 1 minute
            onlineCount++;
          } else {
            offlineCount++;
          }
        });

        statusDiv.innerHTML = `
          📊 <strong>${devices.length}</strong> device(s) total | 
          🟢 <strong>${onlineCount}</strong> online | 
          🔴 <strong>${offlineCount}</strong> offline
        `;
      }

      // Filter data by selected device
      function filterByDevice() {
        const selector = document.getElementById("deviceFilter");
        currentDeviceFilter = selector.value;
        fetchGPSData(); // Refresh data with new filter
      }

      // Update markers for all devices on map
      function updateDeviceMarkers(gpsData) {
        // Group data by device_id
        const deviceData = {};
        gpsData.forEach((point) => {
          if (!deviceData[point.device_id]) {
            deviceData[point.device_id] = [];
          }
          deviceData[point.device_id].push(point);
        });

        // Color palette for different devices
        const colors = [
          "#667eea",
          "#f44336",
          "#4caf50",
          "#ff9800",
          "#2196f3",
          "#9c27b0",
          "#00bcd4",
          "#ffeb3b",
        ];
        let colorIndex = 0;

        // Remove old markers that are no longer in the data
        Object.keys(deviceMarkers).forEach((deviceId) => {
          if (!deviceData[deviceId]) {
            map.removeLayer(deviceMarkers[deviceId]);
            delete deviceMarkers[deviceId];
          }
        });

        // Add or update markers for each device
        Object.keys(deviceData).forEach((deviceId) => {
          const latestPoint = deviceData[deviceId][0]; // Most recent point
          const color = colors[colorIndex % colors.length];
          colorIndex++;

          const lat = latestPoint.latitude;
          const lon = latestPoint.longitude;
          const accuracy = latestPoint.accuracy || 0;

          // Create custom marker HTML
          const markerHtml = `
            <div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; 
                        border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>
          `;

          if (deviceMarkers[deviceId]) {
            // Update existing marker
            deviceMarkers[deviceId].setLatLng([lat, lon]);
            deviceMarkers[deviceId].setPopupContent(`
              <b>Device: ${deviceId}</b><br>
              Lat: ${lat.toFixed(6)}<br>
              Lon: ${lon.toFixed(6)}<br>
              Satellites: ${latestPoint.satellites}<br>
              Accuracy: ${accuracy.toFixed(2)} m<br>
              Time: ${latestPoint.timestamp}
            `);
          } else {
            // Create new marker
            const newMarker = L.marker([lat, lon], {
              icon: L.divIcon({
                className: "custom-device-marker",
                html: markerHtml,
                iconSize: [20, 20],
              }),
            }).addTo(map);

            newMarker.bindPopup(`
              <b>Device: ${deviceId}</b><br>
              Lat: ${lat.toFixed(6)}<br>
              Lon: ${lon.toFixed(6)}<br>
              Satellites: ${latestPoint.satellites}<br>
              Accuracy: ${accuracy.toFixed(2)} m<br>
              Time: ${latestPoint.timestamp}
            `);

            deviceMarkers[deviceId] = newMarker;
          }

          // If this is the selected device or showing all and it's the first one, center on it
          if (
            currentDeviceFilter === "all" &&
            Object.keys(deviceData)[0] === deviceId
          ) {
            map.setView([lat, lon], 15);
            deviceMarkers[deviceId].openPopup();
          } else if (currentDeviceFilter === deviceId) {
            map.setView([lat, lon], 15);
            deviceMarkers[deviceId].openPopup();
          }
        });

        // If showing all devices and there are multiple, fit bounds to show all
        if (
          currentDeviceFilter === "all" &&
          Object.keys(deviceData).length > 1
        ) {
          const allPoints = Object.values(deviceData).flat();
          const bounds = L.latLngBounds(
            allPoints.map((p) => [p.latitude, p.longitude])
          );
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      }

      // Update dashboard with latest data
      function updateDashboard(data) {
        document.getElementById("latValue").textContent =
          data.latitude.toFixed(6);
        document.getElementById("lonValue").textContent =
          data.longitude.toFixed(6);
        document.getElementById("satValue").textContent = data.satellites;
        document.getElementById("hdopValue").textContent = data.hdop.toFixed(2);
        document.getElementById("accuracyValue").textContent = data.accuracy
          ? data.accuracy.toFixed(2) + " m"
          : "--";
        document.getElementById("deviceIdValue").textContent =
          data.device_id || "--";
        document.getElementById("lastUpdate").textContent = new Date(
          data.received_at
        ).toLocaleString();
      }

      // Update table with recent data
      function updateTable(dataArray) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        dataArray.forEach((data) => {
          const row = tbody.insertRow();
          const accuracy = data.accuracy ? data.accuracy.toFixed(2) : "--";
          row.innerHTML = `
                    <td><strong>${data.device_id || "--"}</strong></td>
                    <td>${data.timestamp}</td>
                    <td>${data.latitude.toFixed(6)}</td>
                    <td>${data.longitude.toFixed(6)}</td>
                    <td>${data.satellites}</td>
                    <td>${data.hdop.toFixed(2)}</td>
                    <td>${accuracy}</td>
                `;
        });
      }

      // Fetch train status from backend
      async function fetchTrainStatus() {
        try {
          const response = await fetch(TRAIN_API_URL);
          const result = await response.json();

          if (result.success) {
            updateTrainStatusUI(result.active);
            document.getElementById("trainLastUpdate").textContent = new Date(
              result.updated_at
            ).toLocaleString();
          }
        } catch (error) {
          console.error("Error fetching train status:", error);
        }
      }

      // Update train status UI
      function updateTrainStatusUI(isActive) {
        const toggle = document.getElementById("trainActiveToggle");
        const statusText = document.getElementById("trainStatusText");

        toggle.checked = isActive;

        if (isActive) {
          statusText.textContent = "🟢 Alert System: ACTIVE";
          statusText.className = "train-status-text active";
        } else {
          statusText.textContent = "🔴 Alert System: INACTIVE";
          statusText.className = "train-status-text inactive";
        }
      }

      // Toggle train status
      async function toggleTrainStatus() {
        const toggle = document.getElementById("trainActiveToggle");
        const isActive = toggle.checked;

        try {
          const response = await fetch(TRAIN_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              train_id: "TRAIN_01",
              active: isActive,
            }),
          });

          const result = await response.json();

          if (result.success) {
            updateTrainStatusUI(isActive);
            document.getElementById("trainLastUpdate").textContent =
              new Date().toLocaleString();
            console.log("Train status updated successfully:", isActive);
          } else {
            // Revert toggle if failed
            toggle.checked = !isActive;
            alert("Failed to update train status");
          }
        } catch (error) {
          console.error("Error updating train status:", error);
          // Revert toggle if failed
          toggle.checked = !isActive;
          alert("Error updating train status");
        }
      }

      // Initialize
      initMap();
      fetchDevices(); // Fetch available devices first
      fetchGPSData();
      fetchTrainStatus();
      fetchSessions();

      // Auto-refresh every 15 seconds
      setInterval(fetchGPSData, 15000);
      setInterval(fetchTrainStatus, 5000); // Check train status every 5 seconds
      setInterval(fetchSessions, 10000); // Check sessions every 10 seconds
      setInterval(fetchDevices, 10000); // Check devices every 10 seconds

      // ==== Session Management Functions ====

      // Open modal for new session
      function openNewSessionModal() {
        document.getElementById("newSessionModal").style.display = "block";
      }

      // Close modal
      function closeNewSessionModal() {
        document.getElementById("newSessionModal").style.display = "none";
        document.getElementById("startPoint").value = "";
        document.getElementById("endPoint").value = "";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("newSessionModal");
        if (event.target == modal) {
          closeNewSessionModal();
        }
      };

      // Create new session
      async function createNewSession(event) {
        event.preventDefault();

        const startPoint = document.getElementById("startPoint").value;
        const endPoint = document.getElementById("endPoint").value;

        try {
          const response = await fetch(SESSIONS_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              start_point: startPoint,
              end_point: endPoint,
            }),
          });

          const result = await response.json();

          if (result.success) {
            closeNewSessionModal();
            showSuccessModal(
              "Session Created!",
              `Your session from <strong>${startPoint}</strong> to <strong>${endPoint}</strong> has been created successfully! You can now start it to begin recording GPS data.`
            );
            fetchSessions();
          } else {
            alert("Failed to create session");
          }
        } catch (error) {
          console.error("Error creating session:", error);
          alert("Error creating session");
        }
      }

      // Fetch all sessions
      async function fetchSessions() {
        try {
          const response = await fetch(SESSIONS_API_URL);
          const result = await response.json();

          if (result.success) {
            displaySessions(result.data);
          }
        } catch (error) {
          console.error("Error fetching sessions:", error);
        }
      }

      // Display sessions list
      function displaySessions(sessions) {
        const sessionsList = document.getElementById("sessionsList");

        if (sessions.length === 0) {
          sessionsList.innerHTML =
            '<p style="text-align: center; color: #999;">No sessions yet. Create one to start recording!</p>';
          return;
        }

        let html = "";
        sessions.forEach((session) => {
          const statusClass = session.status;
          const createdDate = new Date(session.created_at).toLocaleString();
          const startedDate = session.started_at
            ? new Date(session.started_at).toLocaleString()
            : "Not started";
          const endedDate = session.ended_at
            ? new Date(session.ended_at).toLocaleString()
            : "Not ended";

          html += `
            <div class="session-item">
              <div class="session-header">
                <div class="session-title">${session.start_point} → ${
            session.end_point
          }</div>
                <span class="session-status ${statusClass}">${session.status.toUpperCase()}</span>
              </div>
              <div class="session-info">
                <div>📅 Created: ${createdDate}</div>
                ${
                  session.status !== "created"
                    ? `<div>▶️ Started: ${startedDate}</div>`
                    : ""
                }
                ${
                  session.status === "completed"
                    ? `<div>⏹️ Ended: ${endedDate}</div>`
                    : ""
                }
                <div>📍 GPS Points: ${session.gps_count}</div>
              </div>
              <div class="session-buttons">
          `;

          if (session.status === "created") {
            html += `<button class="btn-small btn-start" onclick="startSession('${session.id}')">▶️ Start</button>`;
          } else if (session.status === "active") {
            html += `<button class="btn-small btn-stop" onclick="stopSession('${session.id}')">⏹️ Stop</button>`;
          }

          // Add View button for sessions with GPS data
          if (session.gps_count > 0) {
            html += `<button class="btn-small btn-view" onclick="viewSession('${session.id}')">👁️ View</button>`;
          }

          html += `
                <button class="btn-small btn-delete" onclick="deleteSession('${session.id}')">🗑️ Delete</button>
              </div>
            </div>
          `;
        });

        sessionsList.innerHTML = html;
      }

      // Start a session
      async function startSession(sessionId) {
        if (!confirm("Start this session? GPS data will begin recording.")) {
          return;
        }

        try {
          const response = await fetch(
            `${SESSIONS_API_URL}/${sessionId}/start`,
            {
              method: "POST",
            }
          );

          const result = await response.json();

          if (result.success) {
            showSuccessModal(
              "🚀 Session Started!",
              "GPS data is now being recorded. All location data will be saved to this session."
            );
            fetchSessions();
          } else {
            alert("Failed to start session");
          }
        } catch (error) {
          console.error("Error starting session:", error);
          alert("Error starting session");
        }
      }

      // Stop a session
      async function stopSession(sessionId) {
        if (!confirm("Stop this session? GPS recording will end.")) {
          return;
        }

        try {
          const response = await fetch(
            `${SESSIONS_API_URL}/${sessionId}/stop`,
            {
              method: "POST",
            }
          );

          const result = await response.json();

          if (result.success) {
            showSuccessModal(
              "⏹️ Session Stopped!",
              "GPS recording has ended. You can now view the recorded route by clicking the <strong>View</strong> button."
            );
            fetchSessions();
          } else {
            alert("Failed to stop session");
          }
        } catch (error) {
          console.error("Error stopping session:", error);
          alert("Error stopping session");
        }
      }

      // Delete a session
      async function deleteSession(sessionId) {
        if (
          !confirm(
            "Are you sure you want to delete this session? This will also delete all GPS data for this session. This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`${SESSIONS_API_URL}/${sessionId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showSuccessModal(
              "🗑️ Session Deleted",
              "The session and all its GPS data have been permanently removed."
            );
            fetchSessions();
          } else {
            alert("Failed to delete session");
          }
        } catch (error) {
          console.error("Error deleting session:", error);
          alert("Error deleting session");
        }
      }

      // ==== Session View Functions ====

      // View session details
      async function viewSession(sessionId) {
        try {
          // Fetch session details
          const sessionResponse = await fetch(SESSIONS_API_URL);
          const sessionResult = await sessionResponse.json();

          if (!sessionResult.success) {
            alert("Failed to fetch session details");
            return;
          }

          const session = sessionResult.data.find((s) => s.id === sessionId);
          if (!session) {
            alert("Session not found");
            return;
          }

          // Fetch GPS data for this session
          const gpsResponse = await fetch(
            `${SESSIONS_API_URL}/${sessionId}/gps`
          );
          const gpsResult = await gpsResponse.json();

          if (!gpsResult.success) {
            alert("Failed to fetch GPS data");
            return;
          }

          // Display session details
          displaySessionView(session, gpsResult.data);
        } catch (error) {
          console.error("Error viewing session:", error);
          alert("Error loading session data");
        }
      }

      // Display session view modal
      function displaySessionView(session, gpsData) {
        // Update session info
        document.getElementById(
          "sessionViewTitle"
        ).textContent = `📍 Session: ${session.start_point} → ${session.end_point}`;
        document.getElementById("viewStartPoint").textContent =
          session.start_point;
        document.getElementById("viewEndPoint").textContent = session.end_point;
        document.getElementById("viewGpsCount").textContent = session.gps_count;

        // Format times
        const startTime = session.started_at
          ? new Date(session.started_at).toLocaleTimeString()
          : "Not started";
        const endTime = session.ended_at
          ? new Date(session.ended_at).toLocaleTimeString()
          : "Not ended";

        document.getElementById("viewStartTime").textContent = startTime;
        document.getElementById("viewEndTime").textContent = endTime;

        // Calculate and display distance
        const distance = calculateRouteDistance(gpsData);
        document.getElementById("viewDistance").textContent =
          distance > 0 ? `${distance.toFixed(2)} km` : "--";

        // Initialize session map if not already initialized
        if (!sessionMap) {
          sessionMap = L.map("sessionMap").setView([6.9271, 79.8612], 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap contributors",
            maxZoom: 19,
          }).addTo(sessionMap);
        }

        // Clear previous markers and polyline
        sessionMarkers.forEach((marker) => sessionMap.removeLayer(marker));
        sessionMarkers = [];
        if (sessionPolyline) {
          sessionMap.removeLayer(sessionPolyline);
        }

        // Display GPS data on map
        if (gpsData.length > 0) {
          const coordinates = gpsData.map((point) => [
            point.latitude,
            point.longitude,
          ]);

          // Add start marker (green)
          const startMarker = L.marker(coordinates[0], {
            icon: L.divIcon({
              className: "custom-marker",
              html: '<div style="background-color: #4caf50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
              iconSize: [20, 20],
            }),
          })
            .addTo(sessionMap)
            .bindPopup(
              `<b>🟢 Start: ${
                session.start_point
              }</b><br>Lat: ${gpsData[0].latitude.toFixed(
                6
              )}<br>Lon: ${gpsData[0].longitude.toFixed(6)}`
            );
          sessionMarkers.push(startMarker);

          // Add end marker (red) if more than one point
          if (gpsData.length > 1) {
            const lastPoint = gpsData[gpsData.length - 1];
            const endMarker = L.marker(coordinates[coordinates.length - 1], {
              icon: L.divIcon({
                className: "custom-marker",
                html: '<div style="background-color: #f44336; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                iconSize: [20, 20],
              }),
            })
              .addTo(sessionMap)
              .bindPopup(
                `<b>🔴 End: ${
                  session.end_point
                }</b><br>Lat: ${lastPoint.latitude.toFixed(
                  6
                )}<br>Lon: ${lastPoint.longitude.toFixed(6)}`
              );
            sessionMarkers.push(endMarker);

            // Draw route line
            sessionPolyline = L.polyline(coordinates, {
              color: "#667eea",
              weight: 4,
              opacity: 0.7,
            }).addTo(sessionMap);

            // Fit map to show entire route
            sessionMap.fitBounds(sessionPolyline.getBounds(), {
              padding: [50, 50],
            });
          } else {
            // Single point - center on it
            sessionMap.setView(coordinates[0], 15);
          }
        }

        // Display GPS data table
        displaySessionGPSTable(gpsData);

        // Show modal
        document.getElementById("sessionViewModal").style.display = "block";

        // Fix map display issue
        setTimeout(() => {
          if (sessionMap) {
            sessionMap.invalidateSize();
          }
        }, 100);
      }

      // Display GPS data in table
      function displaySessionGPSTable(gpsData) {
        const tbody = document.getElementById("sessionDataTableBody");
        tbody.innerHTML = "";

        if (gpsData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
                No GPS data available for this session.
              </td>
            </tr>
          `;
          return;
        }

        gpsData.forEach((point, index) => {
          const row = tbody.insertRow();
          const accuracy = point.accuracy ? point.accuracy.toFixed(2) : "--";

          row.innerHTML = `
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${
              index + 1
            }</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;"><strong>${
              point.device_id || "--"
            }</strong></td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${
              point.timestamp
            }</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${point.latitude.toFixed(
              6
            )}</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${point.longitude.toFixed(
              6
            )}</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${
              point.satellites
            }</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${point.hdop.toFixed(
              2
            )}</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${accuracy}</td>
          `;

          // Highlight first and last rows
          if (index === 0) {
            row.style.background = "#e8f5e9"; // Light green
          } else if (index === gpsData.length - 1) {
            row.style.background = "#ffebee"; // Light red
          }

          row.style.cursor = "pointer";
          row.onmouseover = function () {
            if (index !== 0 && index !== gpsData.length - 1) {
              this.style.background = "#f5f5f5";
            }
          };
          row.onmouseout = function () {
            if (index === 0) {
              this.style.background = "#e8f5e9";
            } else if (index === gpsData.length - 1) {
              this.style.background = "#ffebee";
            } else {
              this.style.background = "";
            }
          };
        });
      }

      // Calculate total route distance
      function calculateRouteDistance(gpsData) {
        if (gpsData.length < 2) return 0;

        let totalDistance = 0;
        for (let i = 1; i < gpsData.length; i++) {
          const dist = calculateDistance(
            gpsData[i - 1].latitude,
            gpsData[i - 1].longitude,
            gpsData[i].latitude,
            gpsData[i].longitude
          );
          totalDistance += dist;
        }
        return totalDistance;
      }

      // Calculate distance between two coordinates (Haversine formula)
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in kilometers
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Close session view modal
      function closeSessionViewModal() {
        document.getElementById("sessionViewModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("sessionViewModal");
        if (event.target === modal) {
          closeSessionViewModal();
        }
        const successModal = document.getElementById("successModal");
        if (event.target === successModal) {
          closeSuccessModal();
        }
      });

      // ==== Success Modal Functions ====

      // Show success modal
      function showSuccessModal(title, message) {
        document.getElementById("successTitle").textContent = title;
        document.getElementById("successMessage").innerHTML = message;
        document.getElementById("successModal").style.display = "block";
      }

      // Close success modal
      function closeSuccessModal() {
        document.getElementById("successModal").style.display = "none";
      }

      // ==== Tab Switching Functions ====

      // Switch between tabs
      function switchTab(tabName) {
        // Hide all tab contents
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
          tabContents[i].classList.remove("active");
        }

        // Remove active class from all tab buttons
        const tabButtons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tabButtons.length; i++) {
          tabButtons[i].classList.remove("active");
        }

        // Show selected tab content
        if (tabName === "dashboard") {
          document.getElementById("dashboardTab").classList.add("active");
          tabButtons[0].classList.add("active");
        } else if (tabName === "sessions") {
          document.getElementById("sessionsTab").classList.add("active");
          tabButtons[1].classList.add("active");
        }
      }
    </script>
  </body>
</html>
