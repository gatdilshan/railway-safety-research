<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GPS Tracker Dashboard</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 10px;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 20px;
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        padding: 10px;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: clamp(1.1rem, 3vw, 1.5rem);
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        word-wrap: break-word;
      }

      #map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-top: 15px;
        min-height: 300px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      @media (max-width: 1024px) {
        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 10px;
        border-radius: 8px;
        text-align: center;
        min-width: 0;
      }

      .stat-box .label {
        font-size: clamp(0.75rem, 2vw, 0.9rem);
        opacity: 0.9;
        margin-bottom: 5px;
        word-wrap: break-word;
      }

      .stat-box .value {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        font-weight: bold;
        word-break: break-all;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 15px;
      }

      #dataTable {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      #dataTable th,
      #dataTable td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        font-size: clamp(0.75rem, 2vw, 0.95rem);
      }

      #dataTable th {
        background: #667eea;
        color: white;
        font-weight: 600;
        white-space: nowrap;
      }

      #dataTable td {
        white-space: nowrap;
      }

      #dataTable tr:hover {
        background: #f5f5f5;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: clamp(0.9rem, 2vw, 1rem);
        margin-top: 15px;
        transition: transform 0.2s;
        width: 100%;
        max-width: 300px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: 600;
      }

      .status.online {
        background: #4caf50;
        color: white;
      }

      .status.offline {
        background: #f44336;
        color: white;
      }

      .train-control {
        margin-top: 20px;
        text-align: center;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 40px;
        margin: 20px auto;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 40px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 32px;
        width: 32px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #4caf50;
      }

      input:checked + .slider:before {
        transform: translateX(40px);
      }

      .train-status-text {
        font-size: 1.2em;
        font-weight: bold;
        margin-top: 10px;
      }

      .train-status-text.active {
        color: #4caf50;
      }

      .train-status-text.inactive {
        color: #f44336;
      }

      /* Tablet breakpoint */
      @media (max-width: 1024px) {
        body {
          padding: 15px;
        }

        .dashboard {
          gap: 15px;
        }

        .card {
          padding: 18px;
        }

        #map {
          height: 350px;
        }
      }

      /* Mobile breakpoint */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        h1 {
          margin-bottom: 15px;
        }

        .dashboard {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .card {
          padding: 15px;
        }

        .stats {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        #map {
          height: 300px;
        }

        .refresh-btn {
          max-width: 100%;
          padding: 14px 20px;
        }

        .train-control p {
          font-size: 1rem;
        }

        .train-status-text {
          font-size: 1rem;
        }
      }

      /* Small mobile breakpoint */
      @media (max-width: 480px) {
        body {
          padding: 8px;
        }

        h1 {
          margin-bottom: 12px;
        }

        .dashboard {
          gap: 12px;
        }

        .card {
          padding: 12px;
          border-radius: 10px;
        }

        .card h2 {
          font-size: 1.1rem;
          margin-bottom: 12px;
        }

        .stat-box {
          padding: 12px 8px;
        }

        #map {
          height: 250px;
          min-height: 250px;
        }

        #dataTable th,
        #dataTable td {
          padding: 8px 6px;
          font-size: 0.8rem;
        }

        .toggle-switch {
          width: 70px;
          height: 35px;
        }

        .slider:before {
          height: 28px;
          width: 28px;
        }

        input:checked + .slider:before {
          transform: translateX(35px);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üì° GPS Tracker Dashboard</h1>

      <div class="dashboard">
        <div class="card">
          <h2>üìç Live Location</h2>
          <div id="map"></div>
        </div>

        <div class="card">
          <h2>üìä Statistics</h2>
          <div class="stats">
            <div class="stat-box">
              <div class="label">Latitude</div>
              <div class="value" id="latValue">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Longitude</div>
              <div class="value" id="lonValue">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Satellites</div>
              <div class="value" id="satValue">--</div>
            </div>
            <div class="stat-box">
              <div class="label">HDOP</div>
              <div class="value" id="hdopValue">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Accuracy (95%)</div>
              <div class="value" id="accuracyValue">--</div>
            </div>
          </div>
          <p
            style="
              margin-top: 20px;
              text-align: center;
              font-size: clamp(0.9rem, 2vw, 1rem);
            "
          >
            <!-- <strong>Status:</strong>
            <span id="deviceStatus" class="status offline">Offline</span> -->
          </p>
          <p
            style="
              text-align: center;
              margin-top: 10px;
              color: #666;
              font-size: clamp(0.85rem, 2vw, 0.95rem);
            "
          >
            Last Update: <span id="lastUpdate">Never</span>
          </p>
          <div style="display: flex; justify-content: center">
            <button class="refresh-btn" onclick="fetchGPSData()">
              üîÑ Refresh Data
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üöÇ Train Control</h2>
        <div class="train-control">
          <p
            style="
              font-size: clamp(0.95rem, 2.5vw, 1.1rem);
              margin-bottom: 10px;
              color: #666;
              padding: 0 10px;
            "
          >
            Control train alert system (buzzer/lights)
          </p>
          <label class="toggle-switch">
            <input
              type="checkbox"
              id="trainActiveToggle"
              onchange="toggleTrainStatus()"
            />
            <span class="slider"></span>
          </label>
          <div class="train-status-text inactive" id="trainStatusText">
            üî¥ Alert System: INACTIVE
          </div>
          <p
            style="
              margin-top: 15px;
              color: #666;
              font-size: clamp(0.8rem, 2vw, 0.9rem);
            "
          >
            Last Updated: <span id="trainLastUpdate">Never</span>
          </p>
        </div>
      </div>

      <div class="card">
        <h2>üìã Recent GPS Data</h2>
        <div class="table-container">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Satellites</th>
                <th>HDOP</th>
                <th>Accuracy (m)</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #999">
                  Loading data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Use relative URL so it works both locally and on Render
      const API_URL = window.location.origin + "/api/gps";
      const TRAIN_API_URL = window.location.origin + "/api/train/status";
      let map, marker;

      // Initialize map
      function initMap() {
        map = L.map("map").setView([6.9271, 79.8612], 13); // Default: Colombo, Sri Lanka

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
          maxZoom: 19,
        }).addTo(map);

        marker = L.marker([6.9271, 79.8612])
          .addTo(map)
          .bindPopup("Waiting for GPS data...")
          .openPopup();
      }

      // Fetch GPS data from backend
      async function fetchGPSData() {
        try {
          const response = await fetch(API_URL + "?limit=20");
          const result = await response.json();

          if (result.success && result.data.length > 0) {
            const latestData = result.data[0];
            updateDashboard(latestData);
            updateTable(result.data);

            // Update device status
            const timeDiff =
              Date.now() - new Date(latestData.received_at).getTime();
            const statusElement = document.getElementById("deviceStatus");
            if (timeDiff < 60000) {
              // Less than 1 minute
              statusElement.textContent = "Online";
              statusElement.className = "status online";
            } else {
              statusElement.textContent = "Offline";
              statusElement.className = "status offline";
            }
          } else {
            console.log("No GPS data available yet");
          }
        } catch (error) {
          console.error("Error fetching GPS data:", error);
        }
      }

      // Update dashboard with latest data
      function updateDashboard(data) {
        document.getElementById("latValue").textContent =
          data.latitude.toFixed(6);
        document.getElementById("lonValue").textContent =
          data.longitude.toFixed(6);
        document.getElementById("satValue").textContent = data.satellites;
        document.getElementById("hdopValue").textContent = data.hdop.toFixed(2);
        document.getElementById("accuracyValue").textContent = data.accuracy
          ? data.accuracy.toFixed(2) + " m"
          : "--";
        document.getElementById("lastUpdate").textContent = new Date(
          data.received_at
        ).toLocaleString();

        // Update map
        const lat = data.latitude;
        const lon = data.longitude;
        const accuracy = data.accuracy || 0;
        map.setView([lat, lon], 15);
        marker
          .setLatLng([lat, lon])
          .bindPopup(
            `<b>Device: ${data.device_id}</b><br>
                           Lat: ${lat.toFixed(6)}<br>
                           Lon: ${lon.toFixed(6)}<br>
                           Satellites: ${data.satellites}<br>
                           Accuracy: ${accuracy.toFixed(2)} m<br>
                           Time: ${data.timestamp}`
          )
          .openPopup();
      }

      // Update table with recent data
      function updateTable(dataArray) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        dataArray.forEach((data) => {
          const row = tbody.insertRow();
          const accuracy = data.accuracy ? data.accuracy.toFixed(2) : "--";
          row.innerHTML = `
                    <td>${data.timestamp}</td>
                    <td>${data.latitude.toFixed(6)}</td>
                    <td>${data.longitude.toFixed(6)}</td>
                    <td>${data.satellites}</td>
                    <td>${data.hdop.toFixed(2)}</td>
                    <td>${accuracy}</td>
                `;
        });
      }

      // Fetch train status from backend
      async function fetchTrainStatus() {
        try {
          const response = await fetch(TRAIN_API_URL);
          const result = await response.json();

          if (result.success) {
            updateTrainStatusUI(result.active);
            document.getElementById("trainLastUpdate").textContent = new Date(
              result.updated_at
            ).toLocaleString();
          }
        } catch (error) {
          console.error("Error fetching train status:", error);
        }
      }

      // Update train status UI
      function updateTrainStatusUI(isActive) {
        const toggle = document.getElementById("trainActiveToggle");
        const statusText = document.getElementById("trainStatusText");

        toggle.checked = isActive;

        if (isActive) {
          statusText.textContent = "üü¢ Alert System: ACTIVE";
          statusText.className = "train-status-text active";
        } else {
          statusText.textContent = "üî¥ Alert System: INACTIVE";
          statusText.className = "train-status-text inactive";
        }
      }

      // Toggle train status
      async function toggleTrainStatus() {
        const toggle = document.getElementById("trainActiveToggle");
        const isActive = toggle.checked;

        try {
          const response = await fetch(TRAIN_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              train_id: "TRAIN_01",
              active: isActive,
            }),
          });

          const result = await response.json();

          if (result.success) {
            updateTrainStatusUI(isActive);
            document.getElementById("trainLastUpdate").textContent =
              new Date().toLocaleString();
            console.log("Train status updated successfully:", isActive);
          } else {
            // Revert toggle if failed
            toggle.checked = !isActive;
            alert("Failed to update train status");
          }
        } catch (error) {
          console.error("Error updating train status:", error);
          // Revert toggle if failed
          toggle.checked = !isActive;
          alert("Error updating train status");
        }
      }

      // Initialize
      initMap();
      fetchGPSData();
      fetchTrainStatus();

      // Auto-refresh every 15 seconds
      setInterval(fetchGPSData, 15000);
      setInterval(fetchTrainStatus, 5000); // Check train status every 5 seconds
    </script>
  </body>
</html>
