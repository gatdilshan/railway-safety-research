<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Railway Safety System</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- SweetAlert2 for beautiful notifications -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Custom SweetAlert2 styling */
      .swal2-popup {
        border-radius: 15px !important;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif !important;
      }

      .swal2-title {
        font-size: 24px !important;
        font-weight: 600 !important;
        color: #333 !important;
      }

      .swal2-content {
        font-size: 16px !important;
        color: #666 !important;
        line-height: 1.5 !important;
      }

      .swal2-confirm {
        border-radius: 8px !important;
        font-weight: 600 !important;
        font-size: 16px !important;
        padding: 12px 24px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        transition: all 0.3s ease !important;
      }

      .swal2-confirm:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2) !important;
      }

      .swal2-success {
        border-color: #4caf50 !important;
      }

      .swal2-error {
        border-color: #f44336 !important;
      }

      .swal2-warning {
        border-color: #ff9800 !important;
      }

      .swal2-timer-progress-bar {
        background: linear-gradient(90deg, #4caf50, #8bc34a) !important;
      }
    </style>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 10px;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 20px;
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        padding: 10px;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: clamp(1.1rem, 3vw, 1.5rem);
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        word-wrap: break-word;
      }

      #map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-top: 15px;
        min-height: 300px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
      }

      @media (max-width: 1024px) {
        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 10px;
        border-radius: 8px;
        text-align: center;
        min-width: 0;
      }

      .stat-box .label {
        font-size: clamp(0.75rem, 2vw, 0.9rem);
        opacity: 0.9;
        margin-bottom: 5px;
        word-wrap: break-word;
      }

      .stat-box .value {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        font-weight: bold;
        word-break: break-all;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 15px;
      }

      #dataTable {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      #dataTable th,
      #dataTable td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        font-size: clamp(0.75rem, 2vw, 0.95rem);
      }

      #dataTable th {
        background: #667eea;
        color: white;
        font-weight: 600;
        white-space: nowrap;
      }

      #dataTable td {
        white-space: nowrap;
      }

      #dataTable tr:hover {
        background: #f5f5f5;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: clamp(0.9rem, 2vw, 1rem);
        margin-top: 15px;
        transition: transform 0.2s;
        width: 100%;
        max-width: 300px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: 600;
      }

      .status.online {
        background: #4caf50;
        color: white;
      }

      .status.offline {
        background: #f44336;
        color: white;
      }

      .train-control {
        margin-top: 20px;
        text-align: center;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 40px;
        margin: 20px auto;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 40px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 32px;
        width: 32px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #4caf50;
      }

      input:checked + .slider:before {
        transform: translateX(40px);
      }

      .train-status-text {
        font-size: 1.2em;
        font-weight: bold;
        margin-top: 10px;
      }

      .train-status-text.active {
        color: #4caf50;
      }

      .train-status-text.inactive {
        color: #f44336;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 1.5rem;
        color: #667eea;
        margin-bottom: 20px;
        font-weight: bold;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: #000;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        width: 100%;
        transition: transform 0.2s;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* Session Item Styles */
      .session-item {
        background: #f9f9f9;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        transition: transform 0.2s;
      }

      .session-item:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .session-title {
        font-weight: bold;
        color: #333;
        font-size: 1.1rem;
      }

      .session-status {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .session-status.created {
        background: #ffc107;
        color: #000;
      }

      .session-status.active {
        background: #4caf50;
        color: white;
      }

      .session-status.completed {
        background: #9e9e9e;
        color: white;
      }

      .session-info {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      .session-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .btn-small {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: transform 0.2s;
      }

      .btn-small:hover {
        transform: translateY(-2px);
      }

      .btn-start {
        background: #4caf50;
        color: white;
      }

      .btn-stop {
        background: #f44336;
        color: white;
      }

      .btn-delete {
        background: #ff9800;
        color: white;
      }

      .btn-view {
        background: #2196f3;
        color: white;
      }

      /* Session View Modal */
      .session-view-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        overflow-y: auto;
      }

      .session-view-content {
        background-color: white;
        margin: 20px auto;
        padding: 30px;
        border-radius: 12px;
        width: 95%;
        max-width: 1200px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .session-map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin: 20px 0;
        border: 2px solid #667eea;
      }

      .session-data-table {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .route-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .route-info-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .route-info-box .label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .route-info-box .value {
        font-size: 1.3rem;
        font-weight: bold;
      }

      /* Success Confirmation Modal */
      .success-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .success-modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.4s ease-out;
        overflow: hidden;
      }

      .success-modal-header {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        padding: 30px 20px;
        text-align: center;
        color: white;
      }

      .success-icon {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        animation: scaleIn 0.5s ease-out 0.2s both;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0);
        }
        to {
          transform: scale(1);
        }
      }

      .success-modal-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
      }

      .success-modal-body {
        padding: 30px;
        text-align: center;
      }

      .success-modal-body p {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 25px;
        line-height: 1.6;
      }

      .success-modal-footer {
        padding: 0 30px 30px;
        text-align: center;
      }

      .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 14px 40px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .btn-success:active {
        transform: translateY(0);
      }

      /* Tabs Styles */
      .tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        margin-bottom: 20px;
      }

      .tabs-header {
        display: flex;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 0;
      }

      .tab-button {
        flex: 1;
        padding: 18px 20px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        border-bottom: 3px solid transparent;
      }

      .tab-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .tab-button.active {
        color: white;
        background: rgba(255, 255, 255, 0.15);
        border-bottom: 3px solid white;
      }

      .tab-content {
        display: none;
        padding: 20px;
        animation: fadeInTab 0.3s ease-in;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeInTab {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .tab-icon {
        margin-right: 8px;
      }

      /* Tablet breakpoint */
      @media (max-width: 1024px) {
        body {
          padding: 15px;
        }

        .dashboard {
          gap: 15px;
        }

        .card {
          padding: 18px;
        }

        #map {
          height: 350px;
        }

        .tab-button {
          padding: 15px 15px;
          font-size: 1rem;
        }

        .tab-icon {
          display: inline;
        }
      }

      /* Mobile breakpoint */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        h1 {
          margin-bottom: 15px;
        }

        .dashboard {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .card {
          padding: 15px;
        }

        .stats {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        #map {
          height: 300px;
        }

        .refresh-btn {
          max-width: 100%;
          padding: 14px 20px;
        }

        .train-control p {
          font-size: 1rem;
        }

        .train-status-text {
          font-size: 1rem;
        }
      }

      /* Collision Warning Styles */
      .collision-warning {
        background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        border: 4px solid #ffffff;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
        animation: pulseWarning 1.5s infinite;
        margin-bottom: 15px;
      }

      @keyframes pulseWarning {
        0%,
        100% {
          box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 50px rgba(255, 0, 0, 0.9);
          transform: scale(1.02);
        }
      }

      .collision-light {
        width: 80px;
        height: 80px;
        margin: 0 auto 15px;
        border-radius: 50%;
        background: radial-gradient(circle, #ff0000, #8b0000);
        animation: blinkRed 0.5s infinite;
        box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
      }

      @keyframes blinkRed {
        0%,
        49% {
          background: radial-gradient(circle, #ff0000, #8b0000);
          box-shadow: 0 0 40px rgba(255, 0, 0, 1);
        }
        50%,
        100% {
          background: radial-gradient(circle, #8b0000, #4b0000);
          box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
      }

      .collision-title {
        color: white;
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .collision-message {
        color: white;
        font-size: 1.1rem;
        margin-bottom: 15px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      .collision-details {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        color: white;
      }

      .collision-safe {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        border: 3px solid #ffffff;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        color: white;
      }

      .safe-light {
        width: 60px;
        height: 60px;
        margin: 0 auto 12px;
        border-radius: 50%;
        background: radial-gradient(circle, #4caf50, #2e7d32);
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
      }

      /* Small mobile breakpoint */
      @media (max-width: 480px) {
        body {
          padding: 8px;
        }

        .collision-light {
          width: 60px;
          height: 60px;
          font-size: 2rem;
        }

        .collision-title {
          font-size: 1.4rem;
        }

        h1 {
          margin-bottom: 12px;
        }

        .dashboard {
          gap: 12px;
        }

        .card {
          padding: 12px;
          border-radius: 10px;
        }

        .card h2 {
          font-size: 1.1rem;
          margin-bottom: 12px;
        }

        .stat-box {
          padding: 12px 8px;
        }

        #map {
          height: 250px;
          min-height: 250px;
        }

        #dataTable th,
        #dataTable td {
          padding: 8px 6px;
          font-size: 0.8rem;
        }

        .toggle-switch {
          width: 70px;
          height: 35px;
        }

        .slider:before {
          height: 28px;
          width: 28px;
        }

        input:checked + .slider:before {
          transform: translateX(35px);
        }

        .success-modal-content {
          margin: 30% auto;
          width: 95%;
          max-width: 350px;
        }

        .success-icon {
          width: 60px;
          height: 60px;
          font-size: 2.5rem;
        }

        .success-modal-header h2 {
          font-size: 1.4rem;
        }

        .success-modal-body p {
          font-size: 1rem;
        }

        .btn-success {
          padding: 12px 30px;
          font-size: 1rem;
        }

        .tab-button {
          padding: 12px 10px;
          font-size: 0.9rem;
        }

        .tab-icon {
          font-size: 1rem;
          margin-right: 5px;
        }

        .tab-content {
          padding: 15px;
        }
      }

      /* Beautiful Status Message Animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
      }

      @keyframes glow {
        0% {
          box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        50% {
          box-shadow: 0 4px 30px rgba(16, 185, 129, 0.6);
        }
        100% {
          box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
      }

      /* Distinct Trip Control Buttons */
      .start-trip-btn {
        background: linear-gradient(135deg, #10b981, #059669) !important;
        color: white !important;
        border: 2px solid #047857 !important;
        font-weight: 600 !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
        transition: all 0.3s ease !important;
        font-size: 14px !important;
        min-width: 120px !important;
      }

      .start-trip-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #059669, #047857) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4) !important;
      }

      .start-trip-btn:disabled {
        background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
        border-color: #6b7280 !important;
        box-shadow: none !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
      }

      .stop-trip-btn {
        background: linear-gradient(135deg, #ef4444, #dc2626) !important;
        color: white !important;
        border: 2px solid #b91c1c !important;
        font-weight: 600 !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        transition: all 0.3s ease !important;
        font-size: 14px !important;
        min-width: 120px !important;
      }

      .stop-trip-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4) !important;
      }

      .stop-trip-btn:disabled {
        background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
        border-color: #6b7280 !important;
        box-shadow: none !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
      }
    </style>
    <!-- Sri Lanka Railways Theme Overrides -->
    <style id="slr-theme">
      :root {
        --slr-primary: #0a3d62; /* deep navy */
        --slr-secondary: #0e6ba8; /* railway blue */
        --slr-accent: #ff6a00; /* saffron/orange */
        --slr-surface: #ffffff;
      }

      body {
        background: linear-gradient(
          135deg,
          var(--slr-primary) 0%,
          var(--slr-secondary) 100%
        );
      }

      h1 {
        letter-spacing: 0.5px;
      }

      .card h2 {
        color: var(--slr-secondary);
        border-bottom: 3px solid var(--slr-secondary);
      }

      .stat-box {
        background: linear-gradient(
          135deg,
          var(--slr-secondary) 0%,
          var(--slr-accent) 100%
        );
      }

      .refresh-btn,
      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--slr-secondary) 0%,
          var(--slr-accent) 100%
        );
      }

      #dataTable th {
        background: var(--slr-secondary);
      }

      .modal-header {
        color: var(--slr-secondary);
      }

      .tabs-header {
        background: #ffffff;
        backdrop-filter: blur(6px);
        border-radius: 10px;
        padding: 6px;
      }

      /* Ensure tab labels are visible on light header */
      .tabs-header .tab-button {
        color: var(--slr-primary) !important;
      }

      .tabs-header .tab-button:hover {
        color: var(--slr-accent) !important;
        background: rgba(0, 0, 0, 0.04);
      }

      .tabs-header .tab-button.active {
        background: linear-gradient(
          135deg,
          var(--slr-secondary) 0%,
          var(--slr-accent) 100%
        );
        color: #ffffff !important;
        border-bottom-color: transparent;
      }

      /* Top brand bar */
      .slr-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--slr-primary);
        color: #fff;
        border-radius: 10px;
        padding: 10px 14px;
        margin: 6px auto 12px auto;
        max-width: 1400px;
      }

      .slr-topbar .brand {
        font-weight: 700;
        font-size: 1rem;
      }

      .slr-topbar .tag {
        font-size: 0.85rem;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <!-- Audio element for collision warning sound -->
    <audio id="collisionSound" preload="auto">
      <source
        src="https://assets.mixkit.co/active_storage/sfx/2803/2803.wav"
        type="audio/wav"
      />
      <source
        src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        type="audio/mpeg"
      />
    </audio>

    <div class="slr-topbar">
      <div class="brand">üöÜ Sri Lanka Railways</div>
      <div class="tag">National Railway Safety Control Center</div>
    </div>
    <div class="container">
      <h1>üì° Sri Lanka Railways ‚Äî Safety Control Center</h1>

      <!-- Tabs Container -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchTab('dashboard')">
            <span class="tab-icon">üìä</span> Dashboard
          </button>
          <button class="tab-button" onclick="switchTab('sessions')">
            <span class="tab-icon">üóÇÔ∏è</span> Coordinate Sessions
          </button>
          <button class="tab-button" onclick="switchTab('tracks')">
            <span class="tab-icon">üõ§Ô∏è</span> Track Data
          </button>
          <button class="tab-button" onclick="switchTab('realTesting')">
            <span class="tab-icon">üöÜ</span> Real Testing
          </button>
          <button class="tab-button" onclick="switchTab('simulation')">
            <span class="tab-icon">üéÆ</span> Simulation
          </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
          <!-- Collision Warning Panel -->
          <div id="collisionWarningPanel" style="display: none">
            <!-- Will be populated by JavaScript -->
          </div>

          <div class="dashboard">
            <div class="card">
              <h2>üìç Live Location</h2>
              <div id="map"></div>
            </div>

            <div class="card">
              <h2>üìä Statistics</h2>

              <!-- Sound Test Button -->
              <div style="margin-bottom: 15px; text-align: center">
                <button
                  onclick="testCollisionSound()"
                  style="
                    background: linear-gradient(
                      135deg,
                      #ff6a00 0%,
                      #ff8c00 100%
                    );
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    font-weight: 600;
                    transition: transform 0.2s;
                  "
                  onmouseover="this.style.transform='translateY(-2px)'"
                  onmouseout="this.style.transform='translateY(0)'"
                >
                  üîä Test Collision Sound
                </button>
              </div>

              <!-- Device Filter -->
              <div
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: #f5f5f5;
                  border-radius: 8px;
                "
              >
                <label
                  for="deviceFilter"
                  style="
                    font-weight: 600;
                    color: #667eea;
                    margin-bottom: 8px;
                    display: block;
                  "
                >
                  üÜî Select Device:
                </label>
                <select
                  id="deviceFilter"
                  onchange="filterByDevice()"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #667eea;
                    border-radius: 6px;
                    font-size: 1rem;
                    cursor: pointer;
                    background: white;
                  "
                >
                  <option value="all">üì° All Devices</option>
                </select>
                <div
                  id="deviceStatus"
                  style="margin-top: 10px; font-size: 0.9rem; color: #666"
                >
                  Loading devices...
                </div>
              </div>

              <div class="stats">
                <div class="stat-box">
                  <div class="label">Latitude</div>
                  <div class="value" id="latValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Longitude</div>
                  <div class="value" id="lonValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Satellites</div>
                  <div class="value" id="satValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">HDOP</div>
                  <div class="value" id="hdopValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Accuracy</div>
                  <div class="value" id="accuracyValue">--</div>
                </div>
                <div class="stat-box">
                  <div class="label">Device ID</div>
                  <div
                    class="value"
                    id="deviceIdValue"
                    style="font-size: clamp(0.8rem, 2.5vw, 1.2rem)"
                  >
                    --
                  </div>
                </div>
              </div>
              <p
                style="
                  margin-top: 20px;
                  text-align: center;
                  font-size: clamp(0.9rem, 2vw, 1rem);
                "
              >
                <!-- <strong>Status:</strong>
            <span id="deviceStatus" class="status offline">Offline</span> -->
              </p>
              <p
                style="
                  text-align: center;
                  margin-top: 10px;
                  color: #666;
                  font-size: clamp(0.85rem, 2vw, 0.95rem);
                "
              >
                Last Update: <span id="lastUpdate">Never</span>
              </p>
              <div style="display: flex; justify-content: center">
                <button class="refresh-btn" onclick="fetchGPSData()">
                  üîÑ Refresh Data
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>üöÇ Train Control</h2>
            <div class="train-control">
              <p
                style="
                  font-size: clamp(0.95rem, 2.5vw, 1.1rem);
                  margin-bottom: 10px;
                  color: #666;
                  padding: 0 10px;
                "
              >
                Control train alert system (buzzer/lights)
              </p>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="trainActiveToggle"
                  onchange="toggleTrainStatus()"
                />
                <span class="slider"></span>
              </label>
              <div class="train-status-text inactive" id="trainStatusText">
                üî¥ Alert System: INACTIVE
              </div>
              <p
                style="
                  margin-top: 15px;
                  color: #666;
                  font-size: clamp(0.8rem, 2vw, 0.9rem);
                "
              >
                Last Updated: <span id="trainLastUpdate">Never</span>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>üìã Recent GPS Data</h2>
            <div class="table-container">
              <table id="dataTable">
                <thead>
                  <tr>
                    <th>Device ID</th>
                    <th>Timestamp</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Satellites</th>
                    <th>HDOP</th>
                    <th>Accuracy (m)</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="7" style="text-align: center; color: #999">
                      Loading data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- End Dashboard Tab -->

        <!-- Coordinate Sessions Tab -->
        <div id="sessionsTab" class="tab-content">
          <div class="card" style="margin-bottom: 0">
            <h2>üóÇÔ∏è Coordinate Sessions</h2>
            <p style="color: #666; margin-bottom: 20px">
              Create and manage GPS recording sessions. Track your route from
              start to finish and view the complete journey on a map.
            </p>
            <div style="margin-top: 15px">
              <button
                class="refresh-btn"
                onclick="openNewSessionModal()"
                style="margin-bottom: 20px"
              >
                ‚ûï Start New Session
              </button>
              <div id="sessionsList" style="margin-top: 15px">
                <p style="text-align: center; color: #999">
                  Loading sessions...
                </p>
              </div>
            </div>
          </div>
        </div>
        <!-- End Coordinate Sessions Tab -->

        <!-- Track Data Tab -->
        <div id="tracksTab" class="tab-content">
          <div class="card" style="margin-bottom: 0">
            <h2>üõ§Ô∏è Track Data Management</h2>
            <p style="color: #666; margin-bottom: 20px">
              Upload and manage actual track GPS data (CSV files with lat, lon
              columns). The active track is used for collision detection.
            </p>

            <!-- Upload Form -->
            <div
              style="
                background: #f5f5f5;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 25px;
              "
            >
              <h3 style="color: #667eea; margin-bottom: 15px">
                üì§ Upload New Track Data
              </h3>
              <form id="trackUploadForm" onsubmit="uploadTrackData(event)">
                <div class="form-group">
                  <label for="trackName">Track Name *</label>
                  <input
                    type="text"
                    id="trackName"
                    placeholder="e.g., Panadura - Kalutara Section"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="startStation">Start Station</label>
                  <input
                    type="text"
                    id="startStation"
                    placeholder="e.g., Panadura"
                  />
                </div>

                <div class="form-group">
                  <label for="endStation">End Station</label>
                  <input
                    type="text"
                    id="endStation"
                    placeholder="e.g., Kalutara"
                  />
                </div>

                <div class="form-group">
                  <label for="trackFile"
                    >CSV File * (with lat, lon columns)</label
                  >
                  <input
                    type="file"
                    id="trackFile"
                    accept=".csv"
                    required
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 2px dashed #667eea;
                      border-radius: 8px;
                      background: white;
                      cursor: pointer;
                    "
                  />
                  <small style="color: #666; display: block; margin-top: 5px">
                    CSV format: First row should have headers 'lat' and 'lon'
                  </small>
                </div>

                <button type="submit" class="btn-primary" id="uploadBtn">
                  üì§ Upload Track Data
                </button>
              </form>
            </div>

            <!-- Track List -->
            <h3 style="color: #667eea; margin-bottom: 15px">
              üìã Uploaded Track Data
            </h3>
            <div id="tracksList" style="margin-top: 15px">
              <p style="text-align: center; color: #999">Loading tracks...</p>
            </div>
          </div>
        </div>
        <!-- End Track Data Tab -->

        <!-- Real Testing Tab -->
        <div id="realTestingTab" class="tab-content">
          <div class="card" style="margin-bottom: 0">
            <h2>üöÜ Real-World Testing</h2>
            <p style="color: #666; margin-bottom: 20px">
              Select a train and a recorded track, then start a real trip. The
              track will automatically lock ONLY when your real-time GPS data
              matches the actual track data (5 consecutive matches within 30m).
              This ensures you're physically on the correct route before
              locking.
            </p>
            <div
              style="
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <div>
                <label
                  for="realTrainSelect"
                  style="display: block; margin-bottom: 6px"
                  >Train</label
                >
                <select
                  id="realTrainSelect"
                  style="min-width: 220px; padding: 8px"
                ></select>
              </div>
              <div>
                <label
                  for="realTrackSelect"
                  style="display: block; margin-bottom: 6px"
                  >Track</label
                >
                <select
                  id="realTrackSelect"
                  style="min-width: 280px; padding: 8px"
                ></select>
              </div>
              <div style="display: flex; gap: 8px; align-items: center">
                <button
                  id="btnStartReal"
                  class="start-trip-btn"
                  onclick="startRealTesting()"
                >
                  ‚ñ∂Ô∏è Start Trip
                </button>
                <button
                  id="btnStopReal"
                  class="stop-trip-btn"
                  onclick="stopRealTesting()"
                  disabled
                >
                  ‚èπÔ∏è Stop Trip
                </button>
              </div>
            </div>
            <div
              id="realTestingStatus"
              style="margin-top: 20px; padding: 0; transition: all 0.3s ease"
            ></div>
          </div>
        </div>
        <!-- End Real Testing Tab -->

        <!-- Simulation Tab -->
        <div id="simulationTab" class="tab-content">
          <div class="card" style="margin-bottom: 0">
            <h2>üéÆ Railway Collision Detection Simulation</h2>
            <p style="color: #666; margin-bottom: 20px">
              Simulate trains on parallel tracks between Kaluthara and Panadura.
              Test collision detection when multiple trains enter the same
              track.
            </p>

            <!-- Simulation Control Panel -->
            <div
              style="
                background: #f5f5f5;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 25px;
              "
            >
              <h3 style="color: #667eea; margin-bottom: 15px">
                üéõÔ∏è Simulation Controls
              </h3>

              <!-- Reset Button -->
              <button
                class="btn-primary"
                onclick="resetSimulation()"
                style="margin-bottom: 20px; max-width: 200px"
              >
                üîÑ Reset Simulation
              </button>

              <!-- Train Controls Grid -->
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                  gap: 20px;
                  margin-top: 20px;
                "
              >
                <!-- Train 1 Controls -->
                <div
                  style="
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    border: 3px solid #4caf50;
                  "
                >
                  <h4 style="color: #4caf50; margin-bottom: 15px">
                    üöÇ Train 1 (Green)
                  </h4>

                  <div class="form-group">
                    <label>Starting Station:</label>
                    <select
                      id="train1Station"
                      style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #ddd;
                        border-radius: 6px;
                      "
                      onchange="updateTrainPosition('train1')"
                    >
                      <option value="kaluthara">Kaluthara (North)</option>
                      <option value="panadura">Panadura (South)</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Track Selection:</label>
                    <select
                      id="train1Track"
                      style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #ddd;
                        border-radius: 6px;
                      "
                      onchange="updateTrainPosition('train1')"
                    >
                      <option value="track1">Track 1 (Up Line)</option>
                      <option value="track2">Track 2 (Down Line)</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label
                      >Position: <span id="train1PositionLabel">0%</span></label
                    >
                    <input
                      type="range"
                      id="train1Position"
                      min="0"
                      max="100"
                      value="0"
                      style="width: 100%"
                      oninput="updateTrainPosition('train1')"
                    />
                  </div>

                  <button
                    class="btn-primary"
                    onclick="startTrainSimulation('train1')"
                    id="train1StartBtn"
                    style="
                      background: linear-gradient(
                        135deg,
                        #4caf50 0%,
                        #45a049 100%
                      );
                    "
                  >
                    ‚ñ∂Ô∏è Start Train 1
                  </button>
                  <button
                    class="btn-primary"
                    onclick="stopTrainSimulation('train1')"
                    id="train1StopBtn"
                    style="background: #f44336; display: none"
                  >
                    ‚èπÔ∏è Stop Train 1
                  </button>
                </div>

                <!-- Train 2 Controls -->
                <div
                  style="
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    border: 3px solid #2196f3;
                  "
                >
                  <h4 style="color: #2196f3; margin-bottom: 15px">
                    üöÇ Train 2 (Blue)
                  </h4>

                  <div class="form-group">
                    <label>Starting Station:</label>
                    <select
                      id="train2Station"
                      style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #ddd;
                        border-radius: 6px;
                      "
                      onchange="updateTrainPosition('train2')"
                    >
                      <option value="kaluthara">Kaluthara (North)</option>
                      <option value="panadura" selected>
                        Panadura (South)
                      </option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Track Selection:</label>
                    <select
                      id="train2Track"
                      style="
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #ddd;
                        border-radius: 6px;
                      "
                      onchange="updateTrainPosition('train2')"
                    >
                      <option value="track1">Track 1 (Up Line)</option>
                      <option value="track2">Track 2 (Down Line)</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label
                      >Position: <span id="train2PositionLabel">0%</span></label
                    >
                    <input
                      type="range"
                      id="train2Position"
                      min="0"
                      max="100"
                      value="0"
                      style="width: 100%"
                      oninput="updateTrainPosition('train2')"
                    />
                  </div>

                  <button
                    class="btn-primary"
                    onclick="startTrainSimulation('train2')"
                    id="train2StartBtn"
                  >
                    ‚ñ∂Ô∏è Start Train 2
                  </button>
                  <button
                    class="btn-primary"
                    onclick="stopTrainSimulation('train2')"
                    id="train2StopBtn"
                    style="background: #f44336; display: none"
                  >
                    ‚èπÔ∏è Stop Train 2
                  </button>
                </div>
              </div>
            </div>

            <!-- Simulation Visualization -->
            <div
              style="
                background: #f9f9f9;
                padding: 30px;
                border-radius: 10px;
                margin-bottom: 25px;
              "
            >
              <h3
                style="color: #667eea; margin-bottom: 20px; text-align: center"
              >
                üõ§Ô∏è Track Visualization: Kaluthara ‚ÜîÔ∏è Panadura
              </h3>

              <!-- Collision Alert -->
              <div id="simulationCollisionAlert" style="display: none">
                <div class="collision-warning" style="margin-bottom: 20px">
                  <div class="collision-light">üö®</div>
                  <div class="collision-title">‚ö†Ô∏è COLLISION DETECTED ‚ö†Ô∏è</div>
                  <div class="collision-message">
                    Both trains are on the same track!
                  </div>
                  <div class="collision-details">
                    <div style="font-size: 1.1rem; margin-bottom: 10px">
                      <strong>üöÇ Trains:</strong> Train 1 & Train 2<br />
                      <strong>üõ§Ô∏è Track:</strong>
                      <span id="collisionTrackName">Track 1</span>
                    </div>
                    <div
                      style="
                        margin-top: 10px;
                        font-size: 1rem;
                        background: rgba(255, 255, 255, 0.3);
                        padding: 12px;
                        border-radius: 5px;
                        font-weight: bold;
                      "
                    >
                      üõë TRAINS STOPPED FOR SAFETY
                    </div>
                    <div
                      style="
                        margin-top: 10px;
                        font-size: 0.9rem;
                        background: rgba(0, 0, 0, 0.2);
                        padding: 10px;
                        border-radius: 5px;
                      "
                    >
                      ‚ö†Ô∏è BUZZER SYSTEM ACTIVATED ‚ö†Ô∏è
                    </div>
                  </div>
                </div>
              </div>

              <!-- No Collision Safe Message -->
              <div id="simulationSafeAlert" style="display: none">
                <div class="collision-safe" style="margin-bottom: 20px">
                  <div class="safe-light">‚úÖ</div>
                  <div style="font-size: 1.3rem; font-weight: bold">
                    All Clear - Safe Operation
                  </div>
                  <div style="font-size: 1rem; margin-top: 8px">
                    Trains are on different tracks or separated
                  </div>
                </div>
              </div>

              <!-- Track Canvas -->
              <div
                style="
                  position: relative;
                  background: white;
                  padding: 40px 20px;
                  border-radius: 10px;
                  min-height: 400px;
                  overflow: hidden;
                "
              >
                <!-- Station Labels -->
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 20px;
                    padding: 0 20px;
                  "
                >
                  <div style="text-align: left">
                    <div
                      style="
                        font-weight: bold;
                        font-size: 1.2rem;
                        color: #667eea;
                      "
                    >
                      üèõÔ∏è Kaluthara
                    </div>
                    <div style="font-size: 0.9rem; color: #666">
                      North Station
                    </div>
                  </div>
                  <div style="text-align: center; color: #999">
                    <div style="font-size: 0.9rem">‚Üê Railway Line ‚Üí</div>
                    <div style="font-size: 0.8rem">~15 km</div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-weight: bold;
                        font-size: 1.2rem;
                        color: #667eea;
                      "
                    >
                      üèõÔ∏è Panadura
                    </div>
                    <div style="font-size: 0.9rem; color: #666">
                      South Station
                    </div>
                  </div>
                </div>

                <!-- Track 1 (Up Line) -->
                <div style="position: relative; margin-bottom: 60px">
                  <div
                    style="
                      font-weight: 600;
                      color: #666;
                      margin-bottom: 10px;
                      padding-left: 20px;
                    "
                  >
                    Track 1 - Up Line (Kaluthara ‚Üí Panadura)
                  </div>
                  <div
                    style="
                      position: relative;
                      height: 40px;
                      background: linear-gradient(
                        to right,
                        #e0e0e0,
                        #bdbdbd,
                        #e0e0e0
                      );
                      border-radius: 5px;
                      border: 2px solid #999;
                    "
                  >
                    <!-- Track lines -->
                    <div
                      style="
                        position: absolute;
                        top: 30%;
                        width: 100%;
                        height: 3px;
                        background: #555;
                      "
                    ></div>
                    <div
                      style="
                        position: absolute;
                        top: 60%;
                        width: 100%;
                        height: 3px;
                        background: #555;
                      "
                    ></div>
                    <!-- Railway ties -->
                    <div
                      style="
                        position: absolute;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background: repeating-linear-gradient(
                          90deg,
                          transparent,
                          transparent 18px,
                          #666 18px,
                          #666 22px
                        );
                        opacity: 0.5;
                      "
                    ></div>

                    <!-- Train 1 on Track 1 -->
                    <div
                      id="train1_track1"
                      class="simulation-train"
                      style="
                        display: none;
                        position: absolute;
                        left: 0%;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        width: 60px;
                        height: 50px;
                        background: #4caf50;
                        border-radius: 10px;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                        transition: left 0.5s ease;
                      "
                    >
                      <div
                        style="
                          text-align: center;
                          color: white;
                          font-weight: bold;
                          line-height: 50px;
                          font-size: 1.5rem;
                        "
                      >
                        üöÇ
                      </div>
                    </div>

                    <!-- Train 2 on Track 1 -->
                    <div
                      id="train2_track1"
                      class="simulation-train"
                      style="
                        display: none;
                        position: absolute;
                        left: 0%;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        width: 60px;
                        height: 50px;
                        background: #2196f3;
                        border-radius: 10px;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                        transition: left 0.5s ease;
                      "
                    >
                      <div
                        style="
                          text-align: center;
                          color: white;
                          font-weight: bold;
                          line-height: 50px;
                          font-size: 1.5rem;
                        "
                      >
                        üöÇ
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Track 2 (Down Line) -->
                <div style="position: relative">
                  <div
                    style="
                      font-weight: 600;
                      color: #666;
                      margin-bottom: 10px;
                      padding-left: 20px;
                    "
                  >
                    Track 2 - Down Line (Panadura ‚Üí Kaluthara)
                  </div>
                  <div
                    style="
                      position: relative;
                      height: 40px;
                      background: linear-gradient(
                        to right,
                        #e0e0e0,
                        #bdbdbd,
                        #e0e0e0
                      );
                      border-radius: 5px;
                      border: 2px solid #999;
                    "
                  >
                    <!-- Track lines -->
                    <div
                      style="
                        position: absolute;
                        top: 30%;
                        width: 100%;
                        height: 3px;
                        background: #555;
                      "
                    ></div>
                    <div
                      style="
                        position: absolute;
                        top: 60%;
                        width: 100%;
                        height: 3px;
                        background: #555;
                      "
                    ></div>
                    <!-- Railway ties -->
                    <div
                      style="
                        position: absolute;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background: repeating-linear-gradient(
                          90deg,
                          transparent,
                          transparent 18px,
                          #666 18px,
                          #666 22px
                        );
                        opacity: 0.5;
                      "
                    ></div>

                    <!-- Train 1 on Track 2 -->
                    <div
                      id="train1_track2"
                      class="simulation-train"
                      style="
                        display: none;
                        position: absolute;
                        left: 0%;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        width: 60px;
                        height: 50px;
                        background: #4caf50;
                        border-radius: 10px;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                        transition: left 0.5s ease;
                      "
                    >
                      <div
                        style="
                          text-align: center;
                          color: white;
                          font-weight: bold;
                          line-height: 50px;
                          font-size: 1.5rem;
                        "
                      >
                        üöÇ
                      </div>
                    </div>

                    <!-- Train 2 on Track 2 -->
                    <div
                      id="train2_track2"
                      class="simulation-train"
                      style="
                        display: none;
                        position: absolute;
                        left: 0%;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        width: 60px;
                        height: 50px;
                        background: #2196f3;
                        border-radius: 10px;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                        transition: left 0.5s ease;
                      "
                    >
                      <div
                        style="
                          text-align: center;
                          color: white;
                          font-weight: bold;
                          line-height: 50px;
                          font-size: 1.5rem;
                        "
                      >
                        üöÇ
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Simulation Status -->
            <div
              style="
                background: white;
                padding: 20px;
                border-radius: 10px;
                border: 2px solid #667eea;
              "
            >
              <h3 style="color: #667eea; margin-bottom: 15px">
                üìä Simulation Status
              </h3>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 15px;
                "
              >
                <div class="route-info-box">
                  <div class="label">Train 1 Status</div>
                  <div class="value" id="simTrain1Status">Ready</div>
                </div>
                <div class="route-info-box">
                  <div class="label">Train 2 Status</div>
                  <div class="value" id="simTrain2Status">Ready</div>
                </div>
                <div class="route-info-box">
                  <div class="label">Train 1 Track</div>
                  <div class="value" id="simTrain1Track">-</div>
                </div>
                <div class="route-info-box">
                  <div class="label">Train 2 Track</div>
                  <div class="value" id="simTrain2Track">-</div>
                </div>
                <div class="route-info-box" style="background: #f44336">
                  <div class="label">Collision Risk</div>
                  <div class="value" id="simCollisionRisk">None</div>
                </div>
                <div class="route-info-box" style="background: #ff9800">
                  <div class="label">Frontend Buzzer</div>
                  <div class="value" id="simBuzzerStatus">OFF</div>
                </div>
                <div class="route-info-box" style="background: #9c27b0">
                  <div class="label">Backend Buzzer (TRAIN_01)</div>
                  <div class="value" id="simBackendBuzzer1">OFF</div>
                </div>
                <div class="route-info-box" style="background: #9c27b0">
                  <div class="label">Backend Buzzer (TRAIN_02)</div>
                  <div class="value" id="simBackendBuzzer2">OFF</div>
                </div>
              </div>

              <!-- Backend Connection Info -->
              <div
                style="
                  margin-top: 20px;
                  padding: 15px;
                  background: #f5f5f5;
                  border-radius: 8px;
                  border-left: 4px solid #667eea;
                "
              >
                <div
                  style="font-weight: 600; color: #667eea; margin-bottom: 8px"
                >
                  üîó Backend Integration Status
                </div>
                <div style="font-size: 0.9rem; color: #666">
                  <div>
                    ‚Ä¢ Train 1: <strong>TRAIN_01</strong> (Device: ESP32_GPS_01)
                  </div>
                  <div>
                    ‚Ä¢ Train 2: <strong>TRAIN_02</strong> (Device: ESP32_GPS_02)
                  </div>
                  <div
                    style="margin-top: 8px; color: #4caf50"
                    id="backendStatusMsg"
                  >
                    ‚úì Connected to backend system
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End Simulation Tab -->
      </div>
      <!-- End Tabs Container -->
    </div>

    <!-- New Session Modal -->
    <div id="newSessionModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeNewSessionModal()">&times;</span>
        <div class="modal-header">üÜï Create New Session</div>
        <form onsubmit="createNewSession(event)">
          <div class="form-group">
            <label for="startPoint">Start Point Name:</label>
            <input
              type="text"
              id="startPoint"
              placeholder="e.g., Colombo Fort"
              required
            />
          </div>
          <div class="form-group">
            <label for="endPoint">End Point Name:</label>
            <input
              type="text"
              id="endPoint"
              placeholder="e.g., Galle"
              required
            />
          </div>
          <button type="submit" class="btn-primary">Create Session</button>
        </form>
      </div>
    </div>

    <!-- Success Confirmation Modal -->
    <div id="successModal" class="success-modal">
      <div class="success-modal-content">
        <div class="success-modal-header">
          <div class="success-icon">‚úì</div>
          <h2 id="successTitle">Success!</h2>
        </div>
        <div class="success-modal-body">
          <p id="successMessage">
            Session created successfully! You can now start it.
          </p>
        </div>
        <div class="success-modal-footer">
          <button class="btn-success" onclick="closeSuccessModal()">OK</button>
        </div>
      </div>
    </div>

    <!-- Session View Modal -->
    <div id="sessionViewModal" class="session-view-modal">
      <div class="session-view-content">
        <span class="close" onclick="closeSessionViewModal()">&times;</span>
        <div class="modal-header" id="sessionViewTitle">üìç Session Details</div>

        <div class="route-info" id="routeInfo">
          <div class="route-info-box">
            <div class="label">Start Point</div>
            <div class="value" id="viewStartPoint">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">End Point</div>
            <div class="value" id="viewEndPoint">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">GPS Points</div>
            <div class="value" id="viewGpsCount">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Distance</div>
            <div class="value" id="viewDistance">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Started</div>
            <div class="value" id="viewStartTime">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Ended</div>
            <div class="value" id="viewEndTime">--</div>
          </div>
        </div>

        <h3 style="color: #667eea; margin-top: 20px">üó∫Ô∏è Route Map</h3>
        <div id="sessionMap" class="session-map"></div>

        <h3 style="color: #667eea; margin-top: 30px">üìã GPS Data</h3>
        <div class="session-data-table">
          <table
            id="sessionDataTable"
            style="width: 100%; border-collapse: collapse"
          >
            <thead>
              <tr style="background: #667eea; color: white">
                <th style="padding: 12px; text-align: left">#</th>
                <th style="padding: 12px; text-align: left">Device ID</th>
                <th style="padding: 12px; text-align: left">Timestamp</th>
                <th style="padding: 12px; text-align: left">Latitude</th>
                <th style="padding: 12px; text-align: left">Longitude</th>
                <th style="padding: 12px; text-align: left">Satellites</th>
                <th style="padding: 12px; text-align: left">HDOP</th>
                <th style="padding: 12px; text-align: left">Accuracy (m)</th>
              </tr>
            </thead>
            <tbody id="sessionDataTableBody">
              <tr>
                <td
                  colspan="8"
                  style="text-align: center; padding: 20px; color: #999"
                >
                  Loading GPS data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button class="btn-primary" onclick="closeSessionViewModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Track Route View Modal -->
    <div id="trackRouteModal" class="session-view-modal">
      <div class="session-view-content">
        <span class="close" onclick="closeTrackRouteModal()">&times;</span>
        <div class="modal-header" id="trackRouteTitle">üõ§Ô∏è Track Route</div>

        <div class="route-info" id="trackRouteInfo">
          <div class="route-info-box">
            <div class="label">Track Name</div>
            <div class="value" id="viewTrackName">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Track ID</div>
            <div class="value" id="viewTrackId">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Route</div>
            <div class="value" id="viewTrackRoute">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">GPS Points</div>
            <div class="value" id="viewTrackPoints">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Filename</div>
            <div class="value" id="viewTrackFilename">--</div>
          </div>
          <div class="route-info-box">
            <div class="label">Uploaded</div>
            <div class="value" id="viewTrackUploaded">--</div>
          </div>
        </div>

        <h3 style="color: #667eea; margin-top: 20px">üó∫Ô∏è Track Route Map</h3>
        <div id="trackRouteMap" class="session-map"></div>

        <div class="session-view-footer">
          <button class="btn-secondary" onclick="closeTrackRouteModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Use relative URL so it works both locally and on Render
      const API_URL = window.location.origin + "/api/gps";
      const TRAIN_API_URL = window.location.origin + "/api/train/status";
      const SESSIONS_API_URL = window.location.origin + "/api/sessions";
      const DEVICES_API_URL = window.location.origin + "/api/devices";
      const TRACKS_API_URL = window.location.origin + "/api/tracks";
      const REAL_TESTING_START_URL =
        window.location.origin + "/api/real-testing/start";
      const REAL_TESTING_STOP_URL =
        window.location.origin + "/api/real-testing/stop";

      // Collision detection variables
      let collisionDetected = false;
      let alarmSound = null;
      let collisionCheckInterval = null;

      let map;
      let sessionMap = null;
      let sessionPolyline = null;
      let sessionMarkers = [];
      let deviceMarkers = {}; // Store markers for each device
      let currentDeviceFilter = "all"; // Current selected device filter
      let allDevices = []; // Store all devices
      let trackRouteMap = null; // Map for track route viewing
      let trackRoutePolyline = null; // Polyline for track route
      let trackRouteMarkers = []; // Markers for track route

      // Initialize map
      function initMap() {
        map = L.map("map").setView([6.9271, 79.8612], 13); // Default: Colombo, Sri Lanka

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
          maxZoom: 19,
        }).addTo(map);
      }

      // Fetch GPS data from backend
      async function fetchGPSData() {
        try {
          let url = API_URL + "?limit=100";

          // If a specific device is selected, fetch only that device's data
          if (currentDeviceFilter !== "all") {
            url = API_URL + "/" + currentDeviceFilter + "?limit=100";
          }

          const response = await fetch(url);
          const result = await response.json();

          if (result.success && result.data.length > 0) {
            // If filtering by device, show latest from that device
            // If showing all, show latest overall
            const latestData = result.data[0];
            updateDashboard(latestData);
            updateTable(result.data);

            // Update all device markers on map
            updateDeviceMarkers(result.data);
          } else {
            console.log("No GPS data available yet");
          }
        } catch (error) {
          console.error("Error fetching GPS data:", error);
        }
      }

      // Fetch and update device list
      async function fetchDevices() {
        try {
          const response = await fetch(DEVICES_API_URL);
          const result = await response.json();

          if (result.success) {
            allDevices = result.devices;
            updateDeviceSelector(result.devices);
            updateDeviceStatusDisplay(result.devices);
          }
        } catch (error) {
          console.error("Error fetching devices:", error);
        }
      }

      // Update device selector dropdown
      function updateDeviceSelector(devices) {
        const selector = document.getElementById("deviceFilter");
        const currentValue = selector.value;

        // Clear existing options except "All Devices"
        selector.innerHTML = '<option value="all">üì° All Devices</option>';

        // Add option for each device
        devices.forEach((device) => {
          const option = document.createElement("option");
          option.value = device.device_id;
          option.textContent = `üÜî ${device.device_id}`;
          selector.appendChild(option);
        });

        // Restore previous selection if it still exists
        if (
          currentValue !== "all" &&
          devices.find((d) => d.device_id === currentValue)
        ) {
          selector.value = currentValue;
        }
      }

      // Update device status display
      function updateDeviceStatusDisplay(devices) {
        const statusDiv = document.getElementById("deviceStatus");
        const now = Date.now();

        if (devices.length === 0) {
          statusDiv.innerHTML = "‚ö†Ô∏è No devices found";
          return;
        }

        let onlineCount = 0;
        let offlineCount = 0;

        devices.forEach((device) => {
          const timeDiff = now - new Date(device.last_seen).getTime();
          if (timeDiff < 60000) {
            // Less than 1 minute
            onlineCount++;
          } else {
            offlineCount++;
          }
        });

        statusDiv.innerHTML = `
          üìä <strong>${devices.length}</strong> device(s) total | 
          üü¢ <strong>${onlineCount}</strong> online | 
          üî¥ <strong>${offlineCount}</strong> offline
        `;
      }

      // Filter data by selected device
      function filterByDevice() {
        const selector = document.getElementById("deviceFilter");
        currentDeviceFilter = selector.value;
        fetchGPSData(); // Refresh data with new filter
      }

      // Update markers for all devices on map
      function updateDeviceMarkers(gpsData) {
        // Group data by device_id
        const deviceData = {};
        gpsData.forEach((point) => {
          if (!deviceData[point.device_id]) {
            deviceData[point.device_id] = [];
          }
          deviceData[point.device_id].push(point);
        });

        // Color palette for different devices
        const colors = [
          "#667eea",
          "#f44336",
          "#4caf50",
          "#ff9800",
          "#2196f3",
          "#9c27b0",
          "#00bcd4",
          "#ffeb3b",
        ];
        let colorIndex = 0;

        // Remove old markers that are no longer in the data
        Object.keys(deviceMarkers).forEach((deviceId) => {
          if (!deviceData[deviceId]) {
            map.removeLayer(deviceMarkers[deviceId]);
            delete deviceMarkers[deviceId];
          }
        });

        // Add or update markers for each device
        Object.keys(deviceData).forEach((deviceId) => {
          const latestPoint = deviceData[deviceId][0]; // Most recent point
          const color = colors[colorIndex % colors.length];
          colorIndex++;

          const lat = latestPoint.latitude;
          const lon = latestPoint.longitude;
          const accuracy = latestPoint.accuracy || 0;

          // Create custom marker HTML
          const markerHtml = `
            <div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; 
                        border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>
          `;

          if (deviceMarkers[deviceId]) {
            // Update existing marker
            deviceMarkers[deviceId].setLatLng([lat, lon]);
            deviceMarkers[deviceId].setPopupContent(`
              <b>Device: ${deviceId}</b><br>
              Lat: ${lat.toFixed(6)}<br>
              Lon: ${lon.toFixed(6)}<br>
              Satellites: ${latestPoint.satellites}<br>
              Accuracy: ${accuracy.toFixed(2)} m<br>
              Time: ${latestPoint.timestamp}
            `);
          } else {
            // Create new marker
            const newMarker = L.marker([lat, lon], {
              icon: L.divIcon({
                className: "custom-device-marker",
                html: markerHtml,
                iconSize: [20, 20],
              }),
            }).addTo(map);

            newMarker.bindPopup(`
              <b>Device: ${deviceId}</b><br>
              Lat: ${lat.toFixed(6)}<br>
              Lon: ${lon.toFixed(6)}<br>
              Satellites: ${latestPoint.satellites}<br>
              Accuracy: ${accuracy.toFixed(2)} m<br>
              Time: ${latestPoint.timestamp}
            `);

            deviceMarkers[deviceId] = newMarker;
          }

          // If this is the selected device or showing all and it's the first one, center on it
          if (
            currentDeviceFilter === "all" &&
            Object.keys(deviceData)[0] === deviceId
          ) {
            map.setView([lat, lon], 15);
            deviceMarkers[deviceId].openPopup();
          } else if (currentDeviceFilter === deviceId) {
            map.setView([lat, lon], 15);
            deviceMarkers[deviceId].openPopup();
          }
        });

        // If showing all devices and there are multiple, fit bounds to show all
        if (
          currentDeviceFilter === "all" &&
          Object.keys(deviceData).length > 1
        ) {
          const allPoints = Object.values(deviceData).flat();
          const bounds = L.latLngBounds(
            allPoints.map((p) => [p.latitude, p.longitude])
          );
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      }

      // Update dashboard with latest data
      function updateDashboard(data) {
        document.getElementById("latValue").textContent =
          data.latitude.toFixed(6);
        document.getElementById("lonValue").textContent =
          data.longitude.toFixed(6);
        document.getElementById("satValue").textContent = data.satellites;
        document.getElementById("hdopValue").textContent = data.hdop.toFixed(2);
        document.getElementById("accuracyValue").textContent = data.accuracy
          ? data.accuracy.toFixed(2) + " m"
          : "--";
        document.getElementById("deviceIdValue").textContent =
          data.device_id || "--";
        document.getElementById("lastUpdate").textContent = new Date(
          data.received_at
        ).toLocaleString();
      }

      // Update table with recent data
      function updateTable(dataArray) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        dataArray.forEach((data) => {
          const row = tbody.insertRow();
          const accuracy = data.accuracy ? data.accuracy.toFixed(2) : "--";
          row.innerHTML = `
                    <td><strong>${data.device_id || "--"}</strong></td>
                    <td>${data.timestamp}</td>
                    <td>${data.latitude.toFixed(6)}</td>
                    <td>${data.longitude.toFixed(6)}</td>
                    <td>${data.satellites}</td>
                    <td>${data.hdop.toFixed(2)}</td>
                    <td>${accuracy}</td>
                `;
        });
      }

      // Fetch train status from backend
      async function fetchTrainStatus() {
        try {
          // Fetch TRAIN_01 status specifically
          const response = await fetch(TRAIN_API_URL + "?train_id=TRAIN_01");
          const result = await response.json();

          if (result.success && result.train_id === "TRAIN_01") {
            updateTrainStatusUI(result.active);
            document.getElementById("trainLastUpdate").textContent = new Date(
              result.updated_at
            ).toLocaleString();
          }
        } catch (error) {
          console.error("Error fetching train status:", error);
        }
      }

      // Update train status UI
      function updateTrainStatusUI(isActive) {
        const toggle = document.getElementById("trainActiveToggle");
        const statusText = document.getElementById("trainStatusText");

        toggle.checked = isActive;

        if (isActive) {
          statusText.textContent = "üü¢ Alert System: ACTIVE";
          statusText.className = "train-status-text active";
        } else {
          statusText.textContent = "üî¥ Alert System: INACTIVE";
          statusText.className = "train-status-text inactive";
        }
      }

      // Toggle train status
      async function toggleTrainStatus() {
        const toggle = document.getElementById("trainActiveToggle");
        const isActive = toggle.checked;

        try {
          const response = await fetch(TRAIN_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              train_id: "TRAIN_01",
              active: isActive,
            }),
          });

          const result = await response.json();

          if (result.success) {
            updateTrainStatusUI(isActive);
            document.getElementById("trainLastUpdate").textContent =
              new Date().toLocaleString();
            console.log("Train status updated successfully:", isActive);
          } else {
            // Revert toggle if failed
            toggle.checked = !isActive;
            Swal.fire({
              icon: "error",
              title: "Update Failed",
              text: "Failed to update train status. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error updating train status:", error);
          // Revert toggle if failed
          toggle.checked = !isActive;
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to update train status. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Initialize
      initMap();
      fetchDevices(); // Fetch available devices first
      fetchGPSData();
      fetchTrainStatus();
      fetchSessions();

      // Auto-refresh every 15 seconds
      setInterval(fetchGPSData, 15000);
      setInterval(fetchTrainStatus, 5000); // Check train status every 5 seconds
      setInterval(fetchSessions, 10000); // Check sessions every 10 seconds
      setInterval(fetchDevices, 10000); // Check devices every 10 seconds
      setInterval(refreshRealTestingStatusUI, 5000); // Check real testing track lock status every 5 seconds

      // ==== Session Management Functions ====

      // Open modal for new session
      function openNewSessionModal() {
        document.getElementById("newSessionModal").style.display = "block";
      }

      // Close modal
      function closeNewSessionModal() {
        document.getElementById("newSessionModal").style.display = "none";
        document.getElementById("startPoint").value = "";
        document.getElementById("endPoint").value = "";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("newSessionModal");
        if (event.target == modal) {
          closeNewSessionModal();
        }
      };

      // Create new session
      async function createNewSession(event) {
        event.preventDefault();

        const startPoint = document.getElementById("startPoint").value;
        const endPoint = document.getElementById("endPoint").value;

        try {
          const response = await fetch(SESSIONS_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              start_point: startPoint,
              end_point: endPoint,
            }),
          });

          const result = await response.json();

          if (result.success) {
            closeNewSessionModal();
            showSuccessModal(
              "Session Created!",
              `Your session from <strong>${startPoint}</strong> to <strong>${endPoint}</strong> has been created successfully! You can now start it to begin recording GPS data.`
            );
            fetchSessions();
          } else {
            Swal.fire({
              icon: "error",
              title: "Session Creation Failed",
              text: "Failed to create session. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error creating session:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to create session. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Fetch all sessions
      async function fetchSessions() {
        try {
          const response = await fetch(SESSIONS_API_URL);
          const result = await response.json();

          if (result.success) {
            displaySessions(result.data);
          }
        } catch (error) {
          console.error("Error fetching sessions:", error);
        }
      }

      // Display sessions list
      function displaySessions(sessions) {
        const sessionsList = document.getElementById("sessionsList");

        if (sessions.length === 0) {
          sessionsList.innerHTML =
            '<p style="text-align: center; color: #999;">No sessions yet. Create one to start recording!</p>';
          return;
        }

        let html = "";
        sessions.forEach((session) => {
          const statusClass = session.status;
          const createdDate = new Date(session.created_at).toLocaleString();
          const startedDate = session.started_at
            ? new Date(session.started_at).toLocaleString()
            : "Not started";
          const endedDate = session.ended_at
            ? new Date(session.ended_at).toLocaleString()
            : "Not ended";

          html += `
            <div class="session-item">
              <div class="session-header">
                <div class="session-title">${session.start_point} ‚Üí ${
            session.end_point
          }</div>
                <span class="session-status ${statusClass}">${session.status.toUpperCase()}</span>
              </div>
              <div class="session-info">
                <div>üìÖ Created: ${createdDate}</div>
                ${
                  session.status !== "created"
                    ? `<div>‚ñ∂Ô∏è Started: ${startedDate}</div>`
                    : ""
                }
                ${
                  session.status === "completed"
                    ? `<div>‚èπÔ∏è Ended: ${endedDate}</div>`
                    : ""
                }
                <div>üìç GPS Points: ${session.gps_count}</div>
              </div>
              <div class="session-buttons">
          `;

          if (session.status === "created") {
            html += `<button class="btn-small btn-start" onclick="startSession('${session.id}')">‚ñ∂Ô∏è Start</button>`;
          } else if (session.status === "active") {
            html += `<button class="btn-small btn-stop" onclick="stopSession('${session.id}')">‚èπÔ∏è Stop</button>`;
          }

          // Add View button for sessions with GPS data
          if (session.gps_count > 0) {
            html += `<button class="btn-small btn-view" onclick="viewSession('${session.id}')">üëÅÔ∏è View</button>`;
          }

          html += `
                <button class="btn-small btn-delete" onclick="deleteSession('${session.id}')">üóëÔ∏è Delete</button>
              </div>
            </div>
          `;
        });

        sessionsList.innerHTML = html;
      }

      // Start a session
      async function startSession(sessionId) {
        const result = await Swal.fire({
          title: "Start Session?",
          text: "GPS data will begin recording for this session.",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Start Recording",
          cancelButtonText: "Cancel",
          confirmButtonColor: "#4caf50",
          cancelButtonColor: "#6c757d",
          reverseButtons: true,
        });

        if (!result.isConfirmed) {
          return;
        }

        try {
          const response = await fetch(
            `${SESSIONS_API_URL}/${sessionId}/start`,
            {
              method: "POST",
            }
          );

          const result = await response.json();

          if (result.success) {
            showSuccessModal(
              "üöÄ Session Started!",
              "GPS data is now being recorded. All location data will be saved to this session."
            );
            fetchSessions();
          } else {
            Swal.fire({
              icon: "error",
              title: "Session Start Failed",
              text: "Failed to start session. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error starting session:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to start session. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Stop a session
      async function stopSession(sessionId) {
        const result = await Swal.fire({
          title: "Stop Session?",
          text: "GPS recording will end for this session.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Stop Recording",
          cancelButtonText: "Continue Recording",
          confirmButtonColor: "#ff9800",
          cancelButtonColor: "#4caf50",
          reverseButtons: true,
        });

        if (!result.isConfirmed) {
          return;
        }

        try {
          const response = await fetch(
            `${SESSIONS_API_URL}/${sessionId}/stop`,
            {
              method: "POST",
            }
          );

          const result = await response.json();

          if (result.success) {
            showSuccessModal(
              "‚èπÔ∏è Session Stopped!",
              "GPS recording has ended. You can now view the recorded route by clicking the <strong>View</strong> button."
            );
            fetchSessions();
          } else {
            Swal.fire({
              icon: "error",
              title: "Session Stop Failed",
              text: "Failed to stop session. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error stopping session:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to stop session. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Delete a session
      async function deleteSession(sessionId) {
        const result = await Swal.fire({
          title: "Delete Session?",
          html: `
            <div style="text-align: left; margin: 20px 0;">
              <p><strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone!</p>
              <p>This will permanently delete:</p>
              <ul style="margin: 10px 0; padding-left: 20px;">
                <li>The session record</li>
                <li>All GPS data for this session</li>
                <li>All associated route information</li>
              </ul>
            </div>
          `,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, Delete Permanently",
          cancelButtonText: "Cancel",
          confirmButtonColor: "#f44336",
          cancelButtonColor: "#6c757d",
          reverseButtons: true,
        });

        if (!result.isConfirmed) {
          return;
        }

        try {
          const response = await fetch(`${SESSIONS_API_URL}/${sessionId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showSuccessModal(
              "üóëÔ∏è Session Deleted",
              "The session and all its GPS data have been permanently removed."
            );
            fetchSessions();
          } else {
            Swal.fire({
              icon: "error",
              title: "Session Deletion Failed",
              text: "Failed to delete session. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error deleting session:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to delete session. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // ==== Session View Functions ====

      // View session details
      async function viewSession(sessionId) {
        try {
          // Fetch session details
          const sessionResponse = await fetch(SESSIONS_API_URL);
          const sessionResult = await sessionResponse.json();

          if (!sessionResult.success) {
            Swal.fire({
              icon: "error",
              title: "Data Error",
              text: "Failed to fetch session details. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
            return;
          }

          const session = sessionResult.data.find((s) => s.id === sessionId);
          if (!session) {
            Swal.fire({
              icon: "error",
              title: "Session Not Found",
              text: "The requested session could not be found.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
            return;
          }

          // Fetch GPS data for this session
          const gpsResponse = await fetch(
            `${SESSIONS_API_URL}/${sessionId}/gps`
          );
          const gpsResult = await gpsResponse.json();

          if (!gpsResult.success) {
            Swal.fire({
              icon: "error",
              title: "Data Error",
              text: "Failed to fetch GPS data for this session.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
            return;
          }

          // Display session details
          displaySessionView(session, gpsResult.data);
        } catch (error) {
          console.error("Error viewing session:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to load session data. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Display session view modal
      function displaySessionView(session, gpsData) {
        // Update session info
        document.getElementById(
          "sessionViewTitle"
        ).textContent = `üìç Session: ${session.start_point} ‚Üí ${session.end_point}`;
        document.getElementById("viewStartPoint").textContent =
          session.start_point;
        document.getElementById("viewEndPoint").textContent = session.end_point;
        document.getElementById("viewGpsCount").textContent = session.gps_count;

        // Format times
        const startTime = session.started_at
          ? new Date(session.started_at).toLocaleTimeString()
          : "Not started";
        const endTime = session.ended_at
          ? new Date(session.ended_at).toLocaleTimeString()
          : "Not ended";

        document.getElementById("viewStartTime").textContent = startTime;
        document.getElementById("viewEndTime").textContent = endTime;

        // Calculate and display distance
        const distance = calculateRouteDistance(gpsData);
        document.getElementById("viewDistance").textContent =
          distance > 0 ? `${distance.toFixed(2)} km` : "--";

        // Initialize session map if not already initialized
        if (!sessionMap) {
          sessionMap = L.map("sessionMap").setView([6.9271, 79.8612], 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap contributors",
            maxZoom: 19,
          }).addTo(sessionMap);
        }

        // Clear previous markers and polyline
        sessionMarkers.forEach((marker) => sessionMap.removeLayer(marker));
        sessionMarkers = [];
        if (sessionPolyline) {
          sessionMap.removeLayer(sessionPolyline);
        }

        // Display GPS data on map
        if (gpsData.length > 0) {
          const coordinates = gpsData.map((point) => [
            point.latitude,
            point.longitude,
          ]);

          // Add start marker (green)
          const startMarker = L.marker(coordinates[0], {
            icon: L.divIcon({
              className: "custom-marker",
              html: '<div style="background-color: #4caf50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
              iconSize: [20, 20],
            }),
          })
            .addTo(sessionMap)
            .bindPopup(
              `<b>üü¢ Start: ${
                session.start_point
              }</b><br>Lat: ${gpsData[0].latitude.toFixed(
                6
              )}<br>Lon: ${gpsData[0].longitude.toFixed(6)}`
            );
          sessionMarkers.push(startMarker);

          // Add end marker (red) if more than one point
          if (gpsData.length > 1) {
            const lastPoint = gpsData[gpsData.length - 1];
            const endMarker = L.marker(coordinates[coordinates.length - 1], {
              icon: L.divIcon({
                className: "custom-marker",
                html: '<div style="background-color: #f44336; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                iconSize: [20, 20],
              }),
            })
              .addTo(sessionMap)
              .bindPopup(
                `<b>üî¥ End: ${
                  session.end_point
                }</b><br>Lat: ${lastPoint.latitude.toFixed(
                  6
                )}<br>Lon: ${lastPoint.longitude.toFixed(6)}`
              );
            sessionMarkers.push(endMarker);

            // Draw route line
            sessionPolyline = L.polyline(coordinates, {
              color: "#667eea",
              weight: 4,
              opacity: 0.7,
            }).addTo(sessionMap);

            // Fit map to show entire route
            sessionMap.fitBounds(sessionPolyline.getBounds(), {
              padding: [50, 50],
            });
          } else {
            // Single point - center on it
            sessionMap.setView(coordinates[0], 15);
          }
        }

        // Display GPS data table
        displaySessionGPSTable(gpsData);

        // Show modal
        document.getElementById("sessionViewModal").style.display = "block";

        // Fix map display issue
        setTimeout(() => {
          if (sessionMap) {
            sessionMap.invalidateSize();
          }
        }, 100);
      }

      // Display GPS data in table
      function displaySessionGPSTable(gpsData) {
        const tbody = document.getElementById("sessionDataTableBody");
        tbody.innerHTML = "";

        if (gpsData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
                No GPS data available for this session.
              </td>
            </tr>
          `;
          return;
        }

        gpsData.forEach((point, index) => {
          const row = tbody.insertRow();
          const accuracy = point.accuracy ? point.accuracy.toFixed(2) : "--";

          row.innerHTML = `
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${
              index + 1
            }</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;"><strong>${
              point.device_id || "--"
            }</strong></td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${
              point.timestamp
            }</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${point.latitude.toFixed(
              6
            )}</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${point.longitude.toFixed(
              6
            )}</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${
              point.satellites
            }</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${point.hdop.toFixed(
              2
            )}</td>
            <td style="padding: 12px; border-bottom: 1px solid #ddd;">${accuracy}</td>
          `;

          // Highlight first and last rows
          if (index === 0) {
            row.style.background = "#e8f5e9"; // Light green
          } else if (index === gpsData.length - 1) {
            row.style.background = "#ffebee"; // Light red
          }

          row.style.cursor = "pointer";
          row.onmouseover = function () {
            if (index !== 0 && index !== gpsData.length - 1) {
              this.style.background = "#f5f5f5";
            }
          };
          row.onmouseout = function () {
            if (index === 0) {
              this.style.background = "#e8f5e9";
            } else if (index === gpsData.length - 1) {
              this.style.background = "#ffebee";
            } else {
              this.style.background = "";
            }
          };
        });
      }

      // Calculate total route distance
      function calculateRouteDistance(gpsData) {
        if (gpsData.length < 2) return 0;

        let totalDistance = 0;
        for (let i = 1; i < gpsData.length; i++) {
          const dist = calculateDistance(
            gpsData[i - 1].latitude,
            gpsData[i - 1].longitude,
            gpsData[i].latitude,
            gpsData[i].longitude
          );
          totalDistance += dist;
        }
        return totalDistance;
      }

      // Calculate distance between two coordinates (Haversine formula)
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in kilometers
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Close session view modal
      function closeSessionViewModal() {
        document.getElementById("sessionViewModal").style.display = "none";
      }

      // ==== Track Route View Functions ====

      // View track route
      async function viewTrackRoute(trackId, trackName) {
        try {
          // Fetch track coordinates
          const response = await fetch(
            `${TRACKS_API_URL}/${trackId}/coordinates`
          );
          const result = await response.json();

          if (!result.success) {
            Swal.fire({
              icon: "error",
              title: "Data Error",
              text: "Failed to fetch track coordinates. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
            return;
          }

          const track = result.track;

          // Display track route modal
          displayTrackRouteView(track);
        } catch (error) {
          console.error("Error viewing track route:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to load track route data. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Display track route view modal
      function displayTrackRouteView(track) {
        // Update track info
        document.getElementById(
          "trackRouteTitle"
        ).textContent = `üõ§Ô∏è Track Route: ${track.name}`;
        document.getElementById("viewTrackName").textContent = track.name;
        document.getElementById("viewTrackId").textContent = track.track_id;
        document.getElementById("viewTrackRoute").textContent =
          track.start_station && track.end_station
            ? `${track.start_station} ‚Üí ${track.end_station}`
            : "Route not specified";
        document.getElementById("viewTrackPoints").textContent =
          track.points_count;
        document.getElementById("viewTrackFilename").textContent =
          track.filename || "N/A";

        const uploadDate = new Date(track.uploaded_at).toLocaleString();
        document.getElementById("viewTrackUploaded").textContent = uploadDate;

        // Initialize track route map if not already initialized
        if (!trackRouteMap) {
          trackRouteMap = L.map("trackRouteMap").setView([6.9271, 79.8612], 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap contributors",
            maxZoom: 19,
          }).addTo(trackRouteMap);
        }

        // Clear previous markers and polyline
        trackRouteMarkers.forEach((marker) =>
          trackRouteMap.removeLayer(marker)
        );
        trackRouteMarkers = [];
        if (trackRoutePolyline) {
          trackRouteMap.removeLayer(trackRoutePolyline);
        }

        // Display track coordinates on map
        if (track.coordinates && track.coordinates.length > 0) {
          const coordinates = track.coordinates.map((point) => [
            point.latitude,
            point.longitude,
          ]);

          // Add start marker (green)
          if (coordinates.length > 0) {
            const startMarker = L.marker(
              [coordinates[0][0], coordinates[0][1]],
              {
                icon: L.divIcon({
                  className: "custom-marker",
                  html: '<div style="background-color: #4caf50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                  iconSize: [20, 20],
                }),
              }
            )
              .addTo(trackRouteMap)
              .bindPopup(
                `<b>üü¢ Start: ${
                  track.start_station || "Track Start"
                }</b><br>Lat: ${coordinates[0][0].toFixed(
                  6
                )}<br>Lon: ${coordinates[0][1].toFixed(6)}`
              );
            trackRouteMarkers.push(startMarker);
          }

          // Add end marker (red)
          if (coordinates.length > 1) {
            const lastPoint = coordinates[coordinates.length - 1];
            const endMarker = L.marker([lastPoint[0], lastPoint[1]], {
              icon: L.divIcon({
                className: "custom-marker",
                html: '<div style="background-color: #f44336; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                iconSize: [20, 20],
              }),
            })
              .addTo(trackRouteMap)
              .bindPopup(
                `<b>üî¥ End: ${
                  track.end_station || "Track End"
                }</b><br>Lat: ${lastPoint[0].toFixed(
                  6
                )}<br>Lon: ${lastPoint[1].toFixed(6)}`
              );
            trackRouteMarkers.push(endMarker);
          }

          // Draw track route line
          trackRoutePolyline = L.polyline(coordinates, {
            color: "#ff9800",
            weight: 4,
            opacity: 0.8,
          }).addTo(trackRouteMap);

          // Fit map to show the entire track
          const bounds = L.latLngBounds(coordinates);
          trackRouteMap.fitBounds(bounds, { padding: [20, 20] });
        }

        // Show modal
        document.getElementById("trackRouteModal").style.display = "block";
      }

      // Close track route modal
      function closeTrackRouteModal() {
        document.getElementById("trackRouteModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.addEventListener("click", function (event) {
        const sessionModal = document.getElementById("sessionViewModal");
        if (event.target === sessionModal) {
          closeSessionViewModal();
        }
        const trackRouteModal = document.getElementById("trackRouteModal");
        if (event.target === trackRouteModal) {
          closeTrackRouteModal();
        }
        const successModal = document.getElementById("successModal");
        if (event.target === successModal) {
          closeSuccessModal();
        }
      });

      // ==== Success Modal Functions ====

      // Show success modal
      function showSuccessModal(title, message) {
        document.getElementById("successTitle").textContent = title;
        document.getElementById("successMessage").innerHTML = message;
        document.getElementById("successModal").style.display = "block";
      }

      // Close success modal
      function closeSuccessModal() {
        document.getElementById("successModal").style.display = "none";
      }

      // ==== Tab Switching Functions ====

      // Switch between tabs
      function switchTab(tabName) {
        // Hide all tab contents
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
          tabContents[i].classList.remove("active");
        }

        // Remove active class from all tab buttons
        const tabButtons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tabButtons.length; i++) {
          tabButtons[i].classList.remove("active");
        }

        // Show selected tab content
        if (tabName === "dashboard") {
          document.getElementById("dashboardTab").classList.add("active");
          tabButtons[0].classList.add("active");
        } else if (tabName === "sessions") {
          document.getElementById("sessionsTab").classList.add("active");
          tabButtons[1].classList.add("active");
        } else if (tabName === "tracks") {
          document.getElementById("tracksTab").classList.add("active");
          tabButtons[2].classList.add("active");
          // Load tracks when tab is opened
          fetchTracks();
        } else if (tabName === "realTesting") {
          document.getElementById("realTestingTab").classList.add("active");
          tabButtons[3].classList.add("active");
          initializeRealTestingTab();
        } else if (tabName === "simulation") {
          document.getElementById("simulationTab").classList.add("active");
          tabButtons[4].classList.add("active");
          // Initialize simulation when tab is opened
          initializeSimulation();
        }
      }

      // ==== Track Data Management Functions ====

      // Fetch and display all tracks
      async function fetchTracks() {
        try {
          const response = await fetch(TRACKS_API_URL);
          const result = await response.json();

          const tracksList = document.getElementById("tracksList");

          if (result.success && result.tracks.length > 0) {
            tracksList.innerHTML = result.tracks
              .map((track) => createTrackItem(track))
              .join("");
          } else {
            tracksList.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #999;">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">üì≠ No track data uploaded yet</p>
                <p>Upload a CSV file to get started</p>
              </div>
            `;
          }
        } catch (error) {
          console.error("Error fetching tracks:", error);
          document.getElementById("tracksList").innerHTML = `
            <p style="text-align: center; color: #f44336;">Error loading tracks</p>
          `;
        }
      }

      // ==== Real Testing Functions ====
      async function initializeRealTestingTab() {
        await Promise.all([populateTrainOptions(), populateTrackOptions()]);
        await refreshRealTestingStatusUI();
      }

      async function populateTrainOptions() {
        const select = document.getElementById("realTrainSelect");
        if (!select) return;
        select.innerHTML = "<option>Loading trains...</option>";
        try {
          const res = await fetch(TRAIN_API_URL);
          const data = await res.json();
          if (!data.success) throw new Error("Failed to load trains");
          const trains = data.trains || [];
          select.innerHTML = trains
            .map(
              (t) =>
                `<option value="${t.train_id}">${t.train_id} (${t.device_id})</option>`
            )
            .join("");
        } catch (e) {
          select.innerHTML = "<option>Error loading trains</option>";
        }
      }

      async function populateTrackOptions() {
        const select = document.getElementById("realTrackSelect");
        if (!select) return;
        select.innerHTML = "<option>Loading tracks...</option>";
        try {
          const res = await fetch(TRACKS_API_URL);
          const data = await res.json();
          const tracks = data.tracks || [];
          select.innerHTML = tracks
            .map(
              (tr) =>
                `<option value="${tr.track_id}">${tr.track_id} ‚Äî ${tr.name}</option>`
            )
            .join("");
        } catch (e) {
          select.innerHTML = "<option>Error loading tracks</option>";
        }
      }

      async function startRealTesting() {
        const trainId = document.getElementById("realTrainSelect").value;
        const trackId = document.getElementById("realTrackSelect").value;
        const statusEl = document.getElementById("realTestingStatus");
        showStatusMessage("Starting trip...", "info", true);
        try {
          const res = await fetch(REAL_TESTING_START_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ train_id: trainId, track_id: trackId }),
          });
          const data = await res.json();
          if (!res.ok || !data.success)
            throw new Error(data.detail || data.message || "Failed to start");
          showStatusMessage(
            `üöÇ Trip Started! Track ${trackId} will lock when GPS matches actual data (${trainId})`,
            "info",
            true
          );
          document.getElementById("btnStartReal").disabled = true;
          document.getElementById("btnStopReal").disabled = false;
        } catch (e) {
          showStatusMessage(`‚ùå Error: ${e.message}`, "error");
        }
      }

      async function stopRealTesting() {
        const trainId = document.getElementById("realTrainSelect").value;
        const trackId = document.getElementById("realTrackSelect").value;
        const statusEl = document.getElementById("realTestingStatus");
        showStatusMessage("Stopping trip...", "info", true);
        try {
          const res = await fetch(REAL_TESTING_STOP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ train_id: trainId, track_id: trackId }),
          });
          const data = await res.json();
          if (!res.ok || !data.success)
            throw new Error(data.detail || data.message || "Failed to stop");
          showStatusMessage(
            `üîì Track ${trackId} unlocked. Trip stopped successfully.`,
            "info",
            true
          );
          document.getElementById("btnStartReal").disabled = false;
          document.getElementById("btnStopReal").disabled = true;
        } catch (e) {
          showStatusMessage(`‚ùå Error: ${e.message}`, "error");
        }
      }

      // Store last status to prevent unnecessary updates
      let lastStatusMessage = "";
      let lastStatusType = "";

      // Beautiful status message function
      function showStatusMessage(message, type = "info", forceUpdate = false) {
        const statusEl = document.getElementById("realTestingStatus");

        // Don't update if message and type are the same (unless forced)
        if (
          !forceUpdate &&
          message === lastStatusMessage &&
          type === lastStatusType
        ) {
          return;
        }

        lastStatusMessage = message;
        lastStatusType = type;

        // Clear any existing content
        statusEl.innerHTML = "";

        // Create the status card
        const statusCard = document.createElement("div");
        statusCard.style.cssText = `
          padding: 16px 20px;
          border-radius: 12px;
          font-weight: 600;
          font-size: 16px;
          text-align: center;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          border: 2px solid;
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateY(-10px);
        `;

        // Set styles based on type
        switch (type) {
          case "success":
            statusCard.style.cssText += `
              background: linear-gradient(135deg, #10B981, #059669);
              color: white;
              border-color: #047857;
              box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            `;
            break;
          case "error":
            statusCard.style.cssText += `
              background: linear-gradient(135deg, #EF4444, #DC2626);
              color: white;
              border-color: #B91C1C;
              box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
            `;
            break;
          case "warning":
            statusCard.style.cssText += `
              background: linear-gradient(135deg, #F59E0B, #D97706);
              color: white;
              border-color: #B45309;
              box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
            `;
            break;
          default: // info
            statusCard.style.cssText += `
              background: linear-gradient(135deg, #3B82F6, #2563EB);
              color: white;
              border-color: #1D4ED8;
              box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            `;
        }

        statusCard.textContent = message;
        statusEl.appendChild(statusCard);

        // Smooth fade-in animation
        setTimeout(() => {
          statusCard.style.opacity = "1";
          statusCard.style.transform = "translateY(0)";
        }, 10);

        // Add pulsing animation for locked status
        if (message.includes("LOCKED") || message.includes("üîí")) {
          statusCard.style.animation = "pulse 2s infinite";
        }
      }

      async function refreshRealTestingStatusUI() {
        // Only refresh if Real Testing tab is active
        const realTestingTab = document.getElementById("realTestingTab");
        if (!realTestingTab || realTestingTab.style.display === "none") {
          return;
        }

        const trainSelect = document.getElementById("realTrainSelect");
        if (!trainSelect || !trainSelect.value) return;
        const trainId = trainSelect.value;
        const statusEl = document.getElementById("realTestingStatus");
        try {
          const res = await fetch(
            `${TRAIN_API_URL}?train_id=${encodeURIComponent(trainId)}`
          );
          const data = await res.json();
          if (!data.success) {
            showStatusMessage("‚ùå Train not found", "error");
            return;
          }
          const selectedTrack = data.current_track || data.selected_track_id;
          const active = data.active;

          // Check if trip is in progress (selected_track_id exists)
          if (data.selected_track_id) {
            // Trip has been started, now check if track is actually locked
            const trackStatusRes = await fetch(
              `${window.location.origin}/api/tracks/${data.selected_track_id}/status`
            );
            const trackStatus = await trackStatusRes.json();

            if (
              trackStatus.locked &&
              trackStatus.locks &&
              trackStatus.locks.length > 0
            ) {
              // Track is actually locked
              const trainLock = trackStatus.locks.find(
                (lock) => lock.train_id === trainId
              );
              if (trainLock) {
                showStatusMessage(
                  `üîí TRACK LOCKED! GPS matched - ${data.selected_track_id} is locked`,
                  "success"
                );
              } else {
                showStatusMessage(
                  `‚ö†Ô∏è Track ${data.selected_track_id} locked by another train`,
                  "warning"
                );
              }
            } else {
              // Trip started but track not locked yet - waiting for GPS match
              showStatusMessage(
                `üöÇ Trip in progress on ${data.selected_track_id}. Waiting for GPS to match track data...`,
                "info"
              );
            }
            document.getElementById("btnStartReal").disabled = true;
            document.getElementById("btnStopReal").disabled = false;
            const trackSelect = document.getElementById("realTrackSelect");
            if (trackSelect) trackSelect.value = data.selected_track_id;
          } else {
            showStatusMessage("üöÇ Idle. No active trip.", "info");
            document.getElementById("btnStartReal").disabled = false;
            document.getElementById("btnStopReal").disabled = true;
          }
        } catch (e) {
          showStatusMessage("‚ùå Error fetching status", "error");
        }
      }

      // keep UI reactive when the user changes selection
      // these elements exist only on the Real Testing tab
      document.addEventListener("change", (e) => {
        if (e.target && e.target.id === "realTrainSelect") {
          refreshRealTestingStatusUI();
        }
      });

      // Create track item HTML
      function createTrackItem(track) {
        const isActive = track.is_active;
        const activeLabel = isActive
          ? '<span style="background: #4caf50; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">‚úÖ ACTIVE</span>'
          : "";
        const uploadDate = new Date(track.uploaded_at).toLocaleString();

        return `
          <div class="session-item" style="${
            isActive ? "border-left-color: #4caf50;" : ""
          }">
            <div class="session-header">
              <div class="session-title">
                üõ§Ô∏è ${track.name || track.track_id}
                ${activeLabel}
              </div>
            </div>
            <div class="session-info">
              <div><strong>Track ID:</strong> ${track.track_id}</div>
              <div><strong>Filename:</strong> ${track.filename || "N/A"}</div>
              ${
                track.start_station
                  ? `<div><strong>Route:</strong> ${track.start_station} ‚Üí ${track.end_station}</div>`
                  : ""
              }
              <div><strong>GPS Points:</strong> ${
                track.points_count || 0
              } coordinates</div>
              <div><strong>Uploaded:</strong> ${uploadDate}</div>
            </div>
            <div class="session-buttons">
              <button class="btn-small" style="background: #2196f3; color: white;" onclick="viewTrackRoute('${
                track.track_id
              }', '${track.name}')">
                üó∫Ô∏è View Route
              </button>
              ${
                !isActive
                  ? `<button class="btn-small" style="background: #4caf50; color: white;" onclick="activateTrack('${track.track_id}', '${track.name}')">
                      ‚úÖ Use This Track
                    </button>`
                  : `<span style="color: #4caf50; font-weight: 600;">Currently in use for collision detection</span>`
              }
              <button class="btn-small" style="background: #f44336; color: white;" onclick="deleteTrack('${
                track.track_id
              }', '${track.name}')">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        `;
      }

      // Upload track data
      async function uploadTrackData(event) {
        event.preventDefault();

        const trackName = document.getElementById("trackName").value;
        const startStation = document.getElementById("startStation").value;
        const endStation = document.getElementById("endStation").value;
        const fileInput = document.getElementById("trackFile");
        const file = fileInput.files[0];

        if (!file) {
          Swal.fire({
            icon: "warning",
            title: "No File Selected",
            text: "Please select a CSV file to upload.",
            confirmButtonText: "OK",
            confirmButtonColor: "#ff9800",
          });
          return;
        }

        // Show loading
        const uploadBtn = document.getElementById("uploadBtn");
        uploadBtn.disabled = true;
        uploadBtn.textContent = "‚è≥ Uploading...";

        try {
          // Read file content
          const fileContent = await file.text();

          // Send to server
          const response = await fetch(`${TRACKS_API_URL}/upload`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              file_content: fileContent,
              filename: file.name,
              name: trackName,
              start_station: startStation,
              end_station: endStation,
            }),
          });

          const result = await response.json();

          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "Track Uploaded!",
              html: `
                <div style="text-align: left; margin: 20px 0;">
                  <p><strong>Track ID:</strong> ${result.track.track_id}</p>
                  <p><strong>GPS Points:</strong> ${result.track.points_count}</p>
                  <p><strong>Status:</strong> Ready to use</p>
                </div>
              `,
              confirmButtonText: "Awesome!",
              confirmButtonColor: "#4caf50",
              timer: 4000,
              timerProgressBar: true,
            });

            // Reset form
            document.getElementById("trackUploadForm").reset();

            // Refresh track list
            fetchTracks();
          } else {
            Swal.fire({
              icon: "error",
              title: "Upload Failed",
              text:
                result.detail ||
                "Failed to upload track. Please check your file format.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error uploading track:", error);
          Swal.fire({
            icon: "error",
            title: "Upload Error",
            text: "Unable to upload track. Please check your file format and try again.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "üì§ Upload Track Data";
        }
      }

      // Activate track
      async function activateTrack(trackId, trackName) {
        const result = await Swal.fire({
          title: "Activate Track?",
          html: `
            <div style="text-align: left; margin: 20px 0;">
              <p><strong>Track:</strong> "${trackName}"</p>
              <p>This will:</p>
              <ul style="margin: 10px 0; padding-left: 20px;">
                <li>Set it as the active track for collision detection</li>
                <li>Reset all current collision states</li>
                <li>Clear all track locks</li>
              </ul>
            </div>
          `,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Activate Track",
          cancelButtonText: "Cancel",
          confirmButtonColor: "#4caf50",
          cancelButtonColor: "#6c757d",
          reverseButtons: true,
        });

        if (!result.isConfirmed) {
          return;
        }

        try {
          const response = await fetch(
            `${TRACKS_API_URL}/${trackId}/activate`,
            {
              method: "POST",
            }
          );

          const result = await response.json();

          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "Track Activated!",
              text: `"${trackName}" is now being used for collision detection.`,
              confirmButtonText: "Great!",
              confirmButtonColor: "#4caf50",
              timer: 3000,
              timerProgressBar: true,
              showConfirmButton: true,
            });
            fetchTracks();
          } else {
            Swal.fire({
              icon: "error",
              title: "Activation Failed",
              text: "Failed to activate track. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error activating track:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to connect to server. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // Delete track
      async function deleteTrack(trackId, trackName) {
        const result = await Swal.fire({
          title: "Delete Track?",
          html: `
            <div style="text-align: left; margin: 20px 0;">
              <p><strong>Track:</strong> "${trackName}"</p>
              <p><strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone!</p>
              <p>This will permanently remove the track from the system.</p>
            </div>
          `,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, Delete",
          cancelButtonText: "Cancel",
          confirmButtonColor: "#f44336",
          cancelButtonColor: "#6c757d",
          reverseButtons: true,
        });

        if (!result.isConfirmed) {
          return;
        }

        try {
          const response = await fetch(`${TRACKS_API_URL}/${trackId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            Swal.fire({
              icon: "success",
              title: "Track Deleted!",
              text: "Track has been successfully removed from the system.",
              confirmButtonText: "OK",
              confirmButtonColor: "#4caf50",
              timer: 2500,
              timerProgressBar: true,
            });
            fetchTracks();
          } else {
            Swal.fire({
              icon: "error",
              title: "Deletion Failed",
              text: "Failed to delete track. Please try again.",
              confirmButtonText: "OK",
              confirmButtonColor: "#f44336",
            });
          }
        } catch (error) {
          console.error("Error deleting track:", error);
          Swal.fire({
            icon: "error",
            title: "Connection Error",
            text: "Unable to delete track. Please check your connection.",
            confirmButtonText: "OK",
            confirmButtonColor: "#f44336",
          });
        }
      }

      // ==== Collision Detection Functions ====

      // Initialize alarm sound
      function initAlarmSound() {
        // Create audio context for alarm sound
        alarmSound = new Audio();
        // Use a data URL for alarm sound (beep pattern)
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();
        alarmSound.context = audioContext;
      }

      // Play alarm sound
      function playAlarmSound() {
        try {
          // Create oscillator for alarm sound
          const context = new (window.AudioContext ||
            window.webkitAudioContext)();
          const oscillator = context.createOscillator();
          const gainNode = context.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(context.destination);

          oscillator.frequency.value = 800; // Frequency in Hz
          oscillator.type = "sine";

          gainNode.gain.setValueAtTime(0.3, context.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            context.currentTime + 0.5
          );

          oscillator.start(context.currentTime);
          oscillator.stop(context.currentTime + 0.5);

          // Play multiple beeps
          setTimeout(() => playAlarmSound(), 600);
        } catch (error) {
          console.error("Error playing alarm:", error);
        }
      }

      // Stop alarm sound
      function stopAlarmSound() {
        if (alarmSound && alarmSound.context) {
          alarmSound.context.close();
          alarmSound = null;
        }
      }

      // Check collision status
      async function checkCollisionStatus() {
        try {
          // Check all train statuses
          const response = await fetch(TRAIN_API_URL);
          const result = await response.json();

          if (result.success && result.trains) {
            // Check if any train has collision detected
            const collisionTrains = result.trains.filter(
              (train) => train.collision_detected
            );

            if (collisionTrains.length > 0) {
              if (!collisionDetected) {
                // Collision just detected!
                collisionDetected = true;
                showCollisionWarning(collisionTrains);
                playAlarmSound();
              } else {
                // Update collision info
                updateCollisionWarning(collisionTrains);
              }
            } else {
              if (collisionDetected) {
                // Collision cleared
                collisionDetected = false;
                hideCollisionWarning();
                stopAlarmSound();
              }
            }
          }
        } catch (error) {
          console.error("Error checking collision status:", error);
        }
      }

      // Play collision warning sound
      function playCollisionSound() {
        const audio = document.getElementById("collisionSound");
        if (audio) {
          audio.currentTime = 0;
          audio.loop = true;
          audio
            .play()
            .catch((err) => console.log("Audio play prevented:", err));
        }
      }

      // Test collision sound function (for testing purposes)
      function testCollisionSound() {
        console.log("üîä Testing collision warning sound...");
        playCollisionSound();

        // Show test notification
        Swal.fire({
          title: "üîä Sound Test",
          text: "Collision warning sound is now playing. You should hear an alert sound.",
          icon: "info",
          timer: 5000,
          showConfirmButton: true,
          confirmButtonText: "Stop Sound & Close",
        }).then(() => {
          stopCollisionSound();
          console.log("üîá Test sound stopped");
        });
      }

      // Stop collision warning sound
      function stopCollisionSound() {
        const audio = document.getElementById("collisionSound");
        if (audio) {
          audio.pause();
          audio.currentTime = 0;
        }
      }

      // Show collision warning
      function showCollisionWarning(trains) {
        const panel = document.getElementById("collisionWarningPanel");
        const trainsList = trains
          .map((t) => `${t.train_id} (${t.device_id})`)
          .join(" & ");
        const trackInfo = trains[0]?.current_track || "Unknown";

        panel.innerHTML = `
          <div class="collision-warning">
            <div class="collision-light">üö®</div>
            <div class="collision-title">‚ö†Ô∏è COLLISION ALERT ‚ö†Ô∏è</div>
            <div class="collision-message">
              Multiple trains detected on the same track!
            </div>
            <div class="collision-details">
              <div style="font-size: 1.1rem; margin-bottom: 10px;">
                <strong>üöÇ Trains Involved:</strong><br>
                ${trainsList}
              </div>
              <div style="font-size: 1rem;">
                <strong>üõ§Ô∏è Track:</strong> ${trackInfo}
              </div>
              <div style="margin-top: 15px; font-size: 0.9rem; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                ‚ö†Ô∏è BUZZER ACTIVATED ON ALL TRAINS ‚ö†Ô∏è
              </div>
            </div>
          </div>
        `;
        panel.style.display = "block";

        // Play warning sound
        playCollisionSound();

        // Scroll to top to show warning
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Update collision warning
      function updateCollisionWarning(trains) {
        // Update the warning with latest info
        showCollisionWarning(trains);
      }

      // Hide collision warning
      function hideCollisionWarning() {
        const panel = document.getElementById("collisionWarningPanel");

        // Stop warning sound
        stopCollisionSound();

        panel.innerHTML = `
          <div class="collision-safe">
            <div class="safe-light">‚úÖ</div>
            <div style="font-size: 1.3rem; font-weight: bold;">All Clear</div>
            <div style="font-size: 1rem; margin-top: 8px;">No collision detected. Tracks are safe.</div>
          </div>
        `;

        // Hide after 3 seconds
        setTimeout(() => {
          panel.style.display = "none";
        }, 3000);
      }

      // Start collision monitoring
      function startCollisionMonitoring() {
        // Check immediately
        checkCollisionStatus();

        // Check every 3 seconds
        collisionCheckInterval = setInterval(checkCollisionStatus, 3000);
        console.log("‚úÖ Collision monitoring started");
      }

      // Stop collision monitoring
      function stopCollisionMonitoring() {
        if (collisionCheckInterval) {
          clearInterval(collisionCheckInterval);
          collisionCheckInterval = null;
        }
        stopAlarmSound();
      }

      // Initialize collision detection when page loads
      window.addEventListener("DOMContentLoaded", () => {
        initAlarmSound();
        startCollisionMonitoring();
        console.log("üõ§Ô∏è Collision Detection System Active");
      });

      // ==== Simulation Functions ====

      // Simulation state
      let simulationState = {
        train1: {
          active: false,
          position: 0,
          track: "track1",
          station: "kaluthara",
          interval: null,
          trainId: "TRAIN_01",
          deviceId: "ESP32_GPS_01",
        },
        train2: {
          active: false,
          position: 0,
          track: "track1",
          station: "panadura",
          interval: null,
          trainId: "TRAIN_02",
          deviceId: "ESP32_GPS_02",
        },
        collisionDetected: false,
        buzzerActive: false,
        alarmInterval: null,
      };

      // Initialize simulation
      async function initializeSimulation() {
        console.log("üéÆ Simulation initialized");
        await resetSimulation();
      }

      // Reset simulation
      async function resetSimulation() {
        // Stop all trains
        stopTrainSimulation("train1");
        stopTrainSimulation("train2");

        // Reset positions
        simulationState.train1.position = 0;
        simulationState.train2.position = 0;

        document.getElementById("train1Position").value = 0;
        document.getElementById("train2Position").value = 0;

        // Reset UI
        updateTrainPosition("train1");
        updateTrainPosition("train2");

        // Clear collision and deactivate backend buzzers
        if (simulationState.collisionDetected) {
          simulationState.collisionDetected = false;
          simulationState.buzzerActive = false;
          await activateBackendBuzzers(false);
          deactivateSimulationBuzzer();
        } else {
          // Make sure backend buzzers are off
          await activateBackendBuzzers(false);
        }

        updateSimulationStatus();

        console.log("üîÑ Simulation reset");
      }

      // Update train position (manual slider)
      function updateTrainPosition(trainId) {
        const positionSlider = document.getElementById(trainId + "Position");
        const positionLabel = document.getElementById(
          trainId + "PositionLabel"
        );
        const trackSelect = document.getElementById(trainId + "Track");
        const stationSelect = document.getElementById(trainId + "Station");

        const position = parseInt(positionSlider.value);
        positionLabel.textContent = position + "%";

        simulationState[trainId].position = position;
        simulationState[trainId].track = trackSelect.value;
        simulationState[trainId].station = stationSelect.value;

        // Update visual position
        updateTrainVisual(trainId);

        // Check collision
        checkSimulationCollision();
      }

      // Update train visual position
      function updateTrainVisual(trainId) {
        const train = simulationState[trainId];
        const track = train.track;
        const position = train.position;

        // Hide all train visuals for this train
        document.getElementById(trainId + "_track1").style.display = "none";
        document.getElementById(trainId + "_track2").style.display = "none";

        // Show train on correct track
        const trainElement = document.getElementById(trainId + "_" + track);
        trainElement.style.display = "block";

        // Calculate position (0-100% of track length)
        // If starting from Panadura (south), reverse the position
        let visualPosition = position;
        if (train.station === "panadura") {
          visualPosition = 100 - position;
        }

        trainElement.style.left = visualPosition + "%";

        // Remove transition during manual slider movement for immediate response
        if (!train.active) {
          trainElement.style.transition = "left 0.1s linear";
        } else {
          trainElement.style.transition = "left 0.5s ease";
        }
      }

      // Start train simulation (auto-move)
      function startTrainSimulation(trainId) {
        if (simulationState[trainId].active) {
          return;
        }

        simulationState[trainId].active = true;

        // Update UI
        document.getElementById(trainId + "StartBtn").style.display = "none";
        document.getElementById(trainId + "StopBtn").style.display =
          "inline-block";

        // Disable controls while moving
        document.getElementById(trainId + "Station").disabled = true;
        document.getElementById(trainId + "Track").disabled = true;

        // Start moving train
        simulationState[trainId].interval = setInterval(() => {
          moveTrainStep(trainId);
        }, 200); // Update every 200ms

        updateSimulationStatus();
        console.log(`‚ñ∂Ô∏è ${trainId} started`);
      }

      // Stop train simulation
      function stopTrainSimulation(trainId) {
        if (!simulationState[trainId].active) {
          return;
        }

        simulationState[trainId].active = false;

        // Clear interval to stop movement
        if (simulationState[trainId].interval) {
          clearInterval(simulationState[trainId].interval);
          simulationState[trainId].interval = null;
        }

        // Update UI
        document.getElementById(trainId + "StartBtn").style.display =
          "inline-block";
        document.getElementById(trainId + "StopBtn").style.display = "none";

        // Enable controls (only if not in collision state)
        if (!simulationState.collisionDetected) {
          document.getElementById(trainId + "Station").disabled = false;
          document.getElementById(trainId + "Track").disabled = false;
        }

        updateSimulationStatus();
        console.log(
          `‚èπÔ∏è ${trainId} stopped at position ${simulationState[trainId].position}%`
        );
      }

      // Move train one step
      function moveTrainStep(trainId) {
        const train = simulationState[trainId];

        // Increment position
        train.position += 1;

        // Stop at end (100%)
        if (train.position >= 100) {
          train.position = 100;
          stopTrainSimulation(trainId);
        }

        // Update slider and visual
        document.getElementById(trainId + "Position").value = train.position;
        document.getElementById(trainId + "PositionLabel").textContent =
          train.position + "%";

        updateTrainVisual(trainId);
        checkSimulationCollision();
      }

      // Check for collision
      async function checkSimulationCollision() {
        const train1 = simulationState.train1;
        const train2 = simulationState.train2;

        // Both trains must have position > 0 to be considered "on track"
        const train1OnTrack = train1.position > 0;
        const train2OnTrack = train2.position > 0;

        // Check if both trains are on the same track
        const sameTrack = train1.track === train2.track;

        // Collision detected if both trains are on the same track and both are on the track
        const collision = train1OnTrack && train2OnTrack && sameTrack;

        if (collision && !simulationState.collisionDetected) {
          // Collision just detected!
          simulationState.collisionDetected = true;
          simulationState.buzzerActive = true;

          // STOP BOTH TRAINS IMMEDIATELY FOR SAFETY!
          stopTrainSimulation("train1");
          stopTrainSimulation("train2");

          // Add visual emergency stop indicator to trains
          addEmergencyStopIndicator("train1");
          addEmergencyStopIndicator("train2");

          // Activate buzzers on backend for both trains
          await activateBackendBuzzers(true);

          activateSimulationBuzzer();

          // Play collision warning sound
          playCollisionSound();

          console.log("üö® COLLISION DETECTED in simulation!");
          console.log("üõë Both trains stopped immediately!");
          console.log("üîä Backend buzzers activated for both trains");
        } else if (!collision && simulationState.collisionDetected) {
          // Collision cleared
          simulationState.collisionDetected = false;
          simulationState.buzzerActive = false;

          // Stop collision warning sound
          stopCollisionSound();

          // Remove emergency stop indicators
          removeEmergencyStopIndicator("train1");
          removeEmergencyStopIndicator("train2");

          // Deactivate buzzers on backend for both trains
          await activateBackendBuzzers(false);

          deactivateSimulationBuzzer();
          console.log("‚úÖ Collision cleared in simulation");
          console.log("üîá Backend buzzers deactivated");
        }

        updateSimulationStatus();
      }

      // Add visual emergency stop indicator to train
      function addEmergencyStopIndicator(trainId) {
        const train = simulationState[trainId];
        const trainElement = document.getElementById(
          trainId + "_" + train.track
        );

        if (trainElement) {
          // Add red pulsing border and stop icon
          trainElement.style.border = "4px solid #ff0000";
          trainElement.style.animation = "pulseWarning 1s infinite";

          // Change the train emoji to stopped train
          const trainContent = trainElement.querySelector("div");
          if (trainContent) {
            trainContent.innerHTML = "üöÇ‚ùå";
            trainContent.style.fontSize = "1.2rem";
          }
        }
      }

      // Remove visual emergency stop indicator from train
      function removeEmergencyStopIndicator(trainId) {
        const train = simulationState[trainId];
        const trainElement = document.getElementById(
          trainId + "_" + train.track
        );

        if (trainElement) {
          // Remove red border and animation
          trainElement.style.border = "none";
          trainElement.style.animation = "none";

          // Restore normal train emoji
          const trainContent = trainElement.querySelector("div");
          if (trainContent) {
            trainContent.innerHTML = "üöÇ";
            trainContent.style.fontSize = "1.5rem";
          }
        }
      }

      // Activate/deactivate backend buzzers for both trains
      async function activateBackendBuzzers(activate) {
        const statusMsg = document.getElementById("backendStatusMsg");
        statusMsg.textContent = activate
          ? "‚è≥ Activating backend buzzers..."
          : "‚è≥ Deactivating backend buzzers...";
        statusMsg.style.color = "#ff9800";

        try {
          // Update Train 1 (TRAIN_01)
          const train1Response = await fetch(TRAIN_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              train_id: simulationState.train1.trainId,
              active: activate,
            }),
          });

          // Update Train 2 (TRAIN_02)
          const train2Response = await fetch(TRAIN_API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              train_id: simulationState.train2.trainId,
              active: activate,
            }),
          });

          const train1Result = await train1Response.json();
          const train2Result = await train2Response.json();

          if (train1Result.success && train2Result.success) {
            console.log(
              `‚úÖ Backend buzzers ${
                activate ? "activated" : "deactivated"
              } for both trains`
            );

            // Update backend buzzer status display
            const buzzer1El = document.getElementById("simBackendBuzzer1");
            const buzzer2El = document.getElementById("simBackendBuzzer2");

            if (activate) {
              buzzer1El.textContent = "ACTIVE üîä";
              buzzer1El.style.animation = "pulseWarning 1s infinite";
              buzzer2El.textContent = "ACTIVE üîä";
              buzzer2El.style.animation = "pulseWarning 1s infinite";

              statusMsg.textContent =
                "‚úÖ Backend buzzers activated successfully!";
              statusMsg.style.color = "#f44336";
            } else {
              buzzer1El.textContent = "OFF";
              buzzer1El.style.animation = "none";
              buzzer2El.textContent = "OFF";
              buzzer2El.style.animation = "none";

              statusMsg.textContent = "‚úì Backend buzzers deactivated";
              statusMsg.style.color = "#4caf50";
            }
          } else {
            console.error("‚ùå Failed to update backend buzzer status");
            statusMsg.textContent = "‚ùå Failed to update backend buzzers";
            statusMsg.style.color = "#f44336";
          }
        } catch (error) {
          console.error("‚ùå Error updating backend buzzers:", error);
          statusMsg.textContent = "‚ùå Error connecting to backend";
          statusMsg.style.color = "#f44336";
        }
      }

      // Activate buzzer alarm
      function activateSimulationBuzzer() {
        // Show collision alert
        document.getElementById("simulationCollisionAlert").style.display =
          "block";
        document.getElementById("simulationSafeAlert").style.display = "none";

        // Update collision track name
        const trackName =
          simulationState.train1.track === "track1"
            ? "Track 1 (Up Line)"
            : "Track 2 (Down Line)";
        document.getElementById("collisionTrackName").textContent = trackName;

        // Play alarm sound
        playSimulationAlarm();
      }

      // Deactivate buzzer alarm
      function deactivateSimulationBuzzer() {
        // Hide collision alert
        document.getElementById("simulationCollisionAlert").style.display =
          "none";
        document.getElementById("simulationSafeAlert").style.display = "block";

        // Stop alarm sound
        stopSimulationAlarm();

        // Hide safe alert after 3 seconds
        setTimeout(() => {
          document.getElementById("simulationSafeAlert").style.display = "none";
        }, 3000);
      }

      // Play alarm sound
      function playSimulationAlarm() {
        if (simulationState.alarmInterval) {
          return; // Already playing
        }

        // Play beep sound repeatedly
        simulationState.alarmInterval = setInterval(() => {
          if (!simulationState.buzzerActive) {
            stopSimulationAlarm();
            return;
          }

          try {
            const context = new (window.AudioContext ||
              window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            oscillator.frequency.value = 800;
            oscillator.type = "sine";

            gainNode.gain.setValueAtTime(0.3, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              context.currentTime + 0.5
            );

            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + 0.5);
          } catch (error) {
            console.error("Error playing alarm:", error);
          }
        }, 600); // Beep every 600ms
      }

      // Stop alarm sound
      function stopSimulationAlarm() {
        if (simulationState.alarmInterval) {
          clearInterval(simulationState.alarmInterval);
          simulationState.alarmInterval = null;
        }
      }

      // Update simulation status display
      function updateSimulationStatus() {
        const train1 = simulationState.train1;
        const train2 = simulationState.train2;

        // Train 1 status
        const train1StatusEl = document.getElementById("simTrain1Status");
        if (train1.active) {
          train1StatusEl.textContent = "Moving (" + train1.position + "%)";
          train1StatusEl.style.color = "#4caf50";
        } else if (train1.position > 0) {
          train1StatusEl.textContent = "Stopped (" + train1.position + "%)";
          train1StatusEl.style.color = "#ff9800";
        } else {
          train1StatusEl.textContent = "Ready";
          train1StatusEl.style.color = "white";
        }

        // Train 2 status
        const train2StatusEl = document.getElementById("simTrain2Status");
        if (train2.active) {
          train2StatusEl.textContent = "Moving (" + train2.position + "%)";
          train2StatusEl.style.color = "#2196f3";
        } else if (train2.position > 0) {
          train2StatusEl.textContent = "Stopped (" + train2.position + "%)";
          train2StatusEl.style.color = "#ff9800";
        } else {
          train2StatusEl.textContent = "Ready";
          train2StatusEl.style.color = "white";
        }

        // Track info
        document.getElementById("simTrain1Track").textContent =
          train1.position > 0
            ? train1.track === "track1"
              ? "Track 1"
              : "Track 2"
            : "-";
        document.getElementById("simTrain2Track").textContent =
          train2.position > 0
            ? train2.track === "track1"
              ? "Track 1"
              : "Track 2"
            : "-";

        // Collision risk
        const collisionRiskEl = document.getElementById("simCollisionRisk");
        if (simulationState.collisionDetected) {
          collisionRiskEl.textContent = "HIGH - COLLISION!";
          collisionRiskEl.style.animation = "pulseWarning 1s infinite";
        } else {
          collisionRiskEl.textContent = "None";
          collisionRiskEl.style.animation = "none";
        }

        // Buzzer status
        const buzzerStatusEl = document.getElementById("simBuzzerStatus");
        if (simulationState.buzzerActive) {
          buzzerStatusEl.textContent = "ACTIVE üîä";
          buzzerStatusEl.style.animation = "pulseWarning 1s infinite";
        } else {
          buzzerStatusEl.textContent = "OFF";
          buzzerStatusEl.style.animation = "none";
        }
      }
    </script>
  </body>
</html>
